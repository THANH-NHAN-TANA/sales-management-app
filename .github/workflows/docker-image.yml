# .github/workflows/docker-image.yml
name: Sales Management Docker CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build . --file Dockerfile --tag sales-management-app:latest
        
    - name: Test Docker image
      run: |
        echo "ğŸ§ª Testing Docker image..."
        
        # Start container
        docker run -d -p 3000:3000 --name test-container sales-management-app:latest
        
        # Wait for container and application to start
        echo "â³ Waiting for application to start..."
        sleep 15
        
        # Check if container is running
        if ! docker ps | grep test-container; then
          echo "âŒ Container not running"
          docker logs test-container
          exit 1
        fi
        
        # Test health endpoint with retry
        echo "ğŸ¥ Testing health endpoint..."
        for i in {1..10}; do
          if curl -f http://localhost:3000/health; then
            echo "âœ… Health check passed!"
            break
          fi
          echo "â³ Attempt $i failed, retrying in 3 seconds..."
          sleep 3
          if [ $i -eq 10 ]; then
            echo "âŒ Health check failed after 10 attempts"
            docker logs test-container
            exit 1
          fi
        done
        
        # Test API endpoints
        echo "ğŸ“Š Testing API endpoints..."
        curl -f http://localhost:3000/api/products || echo "âš ï¸ Products endpoint failed"
        curl -f http://localhost:3000/api/customers || echo "âš ï¸ Customers endpoint failed"
        curl -f http://localhost:3000/api/stats || echo "âš ï¸ Stats endpoint failed"
        
    - name: Show container logs
      if: always()
      run: |
        echo "ğŸ“‹ Container logs:"
        docker logs test-container || echo "No logs available"
        
    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        docker stop test-container || true
        docker rm test-container || true
        
    - name: Show Docker images
      run: |
        echo "ğŸ³ Docker images:"
        docker images
