<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Khách Hàng - Sales Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* Tái sử dụng CSS từ dashboard.html */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 10px;
        font-size: 22px;
      }

      .nav-menu {
        display: flex;
        gap: 25px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        color: white;
        font-weight: 500;
        position: relative;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 600;
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #f0f0f0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #667eea;
        font-size: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .settings-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 120%;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 220px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-15px);
        transition: all 0.4s ease;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .dropdown-item:hover {
        background: #f8f9fa;
      }

      .dropdown-item:first-child {
        border-bottom: 1px solid #eee;
      }

      .dropdown-item:first-child:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .dropdown-item:last-child:hover {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      .dropdown-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
        min-height: calc(100vh - 80px);
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .page-subtitle {
        color: #7f8c8d;
        font-size: 16px;
      }

      /* Customers Section */
      .customers-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .section-header {
        padding: 25px 30px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .customers-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .customers-table th,
      .customers-table td {
        padding: 18px 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #666;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .customers-table th {
        background: #f8f9fa;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #eee;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .customers-table th:nth-child(1),
      .customers-table td:nth-child(1) {
        width: 10%;
      }

      .customers-table th:nth-child(2),
      .customers-table td:nth-child(2) {
        width: 20%;
      }

      .customers-table th:nth-child(3),
      .customers-table td:nth-child(3) {
        width: 20%;
      }

      .customers-table th:nth-child(4),
      .customers-table td:nth-child(4) {
        width: 15%;
      }

      .customers-table th:nth-child(5),
      .customers-table td:nth-child(5) {
        width: 15%;
      }

      .customers-table th:nth-child(6),
      .customers-table td:nth-child(6) {
        width: 10%;
      }

      .customers-table th:nth-child(7),
      .customers-table td:nth-child(7) {
        width: 20%;
        text-align: center;
      }

      @media (max-width: 768px) {
        .customers-table th,
        .customers-table td {
          padding: 12px 8px;
          font-size: 12px;
        }

        .customers-table th:nth-child(7),
        .customers-table td:nth-child(7) {
          width: 25%;
        }
      }

      @media (max-width: 480px) {
        .customers-table th,
        .customers-table td {
          padding: 10px 5px;
          font-size: 11px;
        }

        .customers-table th:nth-child(7),
        .customers-table td:nth-child(7) {
          width: 30%;
        }
      }

      .customers-table tr:hover {
        background: #f8f9fa;
      }

      .customer-id {
        font-weight: 600;
        color: #333;
        font-family: "Courier New", monospace;
      }

      .customer-name {
        font-weight: 500;
        color: #2c3e50;
      }

      /* Action buttons */
      .action-btn {
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        margin: 0 3px;
      }

      .action-btn.view {
        background: #667eea;
        color: white;
      }

      .action-btn.view:hover {
        background: #5a6ed6;
        transform: translateY(-1px);
      }

      .action-btn.edit {
        background: #28a745;
        color: white;
      }

      .action-btn.edit:hover {
        background: #218838;
        transform: translateY(-1px);
      }

      .action-btn.delete {
        background: #dc3545;
        color: white;
      }

      .action-btn.delete:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s ease;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 35px;
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.4s ease;
        position: relative;
      }

      .modal-overlay.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
      }

      .modal-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .modal-body p {
        margin-bottom: 15px;
        font-size: 14px;
        color: #666;
      }

      .modal-body strong {
        color: #2c3e50;
        font-weight: 600;
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-modal:hover {
        background: #f0f0f0;
        color: #666;
      }

      /* Form styles for Update Modal */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        color: #333;
        transition: border-color 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
      }

      .form-input[readonly] {
        background: #f8f9fa;
        cursor: not-allowed;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6ed6;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #666;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      /* Notification styles */
      .notification {
        position: fixed;
        top: 25px;
        right: 25px;
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        z-index: 3000;
        animation: slideInRight 0.4s ease;
        max-width: 350px;
        font-weight: 500;
      }

      .notification.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .notification.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .notification.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .notification.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #667eea;
        font-weight: 600;
        font-size: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: #7f8c8d;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #bdc3c7;
      }

      .empty-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #95a5a6;
      }

      .empty-state p {
        font-size: 14px;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .nav-menu {
          gap: 15px;
        }

        .nav-item {
          padding: 8px 12px;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 15px 20px;
        }

        .nav-menu {
          display: none;
        }

        .logo {
          font-size: 20px;
        }

        .main-content {
          padding: 20px 15px;
        }

        .page-title {
          font-size: 24px;
        }

        .customers-table {
          font-size: 13px;
        }

        .customers-table th,
        .customers-table td {
          padding: 12px 15px;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 12px 15px;
        }

        .user-info {
          gap: 8px;
        }

        .user-name {
          display: none;
        }

        .main-content {
          padding: 15px 10px;
        }

        .customers-table th,
        .customers-table td {
          padding: 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Đang tải dữ liệu...</div>
    </div>

    <header class="header">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>Sales Management System</span>
      </div>

      <nav class="nav-menu">
        <a href="/dashboard" class="nav-item" data-page="dashboard">
          <i class="fas fa-home"></i>
          Tổng quan
        </a>
        <a href="/products-page" class="nav-item" data-page="products">
          <i class="fas fa-box"></i>
          Sản phẩm
        </a>
        <a href="/customers-page" class="nav-item active" data-page="customers">
          <i class="fas fa-users"></i>
          Khách hàng
        </a>
        <a href="/orders-page" class="nav-item" data-page="orders">
          <i class="fas fa-shopping-cart"></i>
          Đơn hàng
        </a>
        <a href="/statistics-page" class="nav-item" data-page="statistics">
          <i class="fas fa-chart-bar"></i>
          Thống Kê
        </a>
      </nav>

      <div class="user-info">
        <span class="user-name" id="userName">Đang tải...</span>
        <div class="user-avatar" id="userAvatar" title="Thông tin cá nhân">
          ?
        </div>
        <button class="settings-btn" id="settingsBtn" title="Cài đặt">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <button class="dropdown-item" id="profileBtn">
            <i class="fas fa-user dropdown-icon"></i>
            Thông tin cá nhân
          </button>
          <button class="dropdown-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt dropdown-icon"></i>
            Đăng xuất
          </button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">Quản Lý Khách Hàng</h1>
        <p class="page-subtitle">Danh sách khách hàng trong hệ thống</p>
      </div>

      <div class="customers-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-users"></i>
            Danh Sách Khách Hàng
          </h2>
        </div>

        <table class="customers-table">
          <thead>
            <tr>
              <th>Mã KH</th>
              <th>Tên</th>
              <th>Email</th>
              <th>Số điện thoại</th>
              <th>Địa chỉ</th>
              <th>Ngày tạo</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="customersTableBody">
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-database"></i>
                <h3>Không có khách hàng nào</h3>
                <p>Hiện tại chưa có dữ liệu khách hàng để hiển thị.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <!-- Customer Details Modal -->
    <div class="modal-overlay" id="customerDetailsModal">
      <div class="modal-content">
        <button class="close-modal" id="closeCustomerModalBtn" title="Đóng">
          ×
        </button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-user"></i>
          </div>
          <h2 class="modal-title">Chi tiết khách hàng</h2>
        </div>

        <div class="modal-body" id="customerDetailsBody">
          <p><strong>ID:</strong> <span id="customerId"></span></p>
          <p><strong>Tên:</strong> <span id="customerName"></span></p>
          <p><strong>Email:</strong> <span id="customerEmail"></span></p>
          <p>
            <strong>Số điện thoại:</strong> <span id="customerPhone"></span>
          </p>
          <p><strong>Địa chỉ:</strong> <span id="customerAddress"></span></p>
          <p><strong>Ngày tạo:</strong> <span id="customerCreatedAt"></span></p>
        </div>
      </div>
    </div>

    <!-- Update Customer Modal -->
    <div class="modal-overlay" id="updateCustomerModal">
      <div class="modal-content">
        <button class="close-modal" id="closeUpdateModalBtn" title="Đóng">
          ×
        </button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-edit"></i>
          </div>
          <h2 class="modal-title">Cập nhật khách hàng</h2>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Mã KH</label>
            <input
              type="text"
              class="form-input"
              id="updateCustomerId"
              readonly
            />
          </div>
          <div class="form-group">
            <label class="form-label">Tên khách hàng</label>
            <input
              type="text"
              class="form-input"
              id="updateCustomerName"
              placeholder="Nhập tên khách hàng"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-input"
              id="updateCustomerEmail"
              placeholder="Nhập email"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Số điện thoại</label>
            <input
              type="text"
              class="form-input"
              id="updateCustomerPhone"
              placeholder="Nhập số điện thoại"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Địa chỉ</label>
            <input
              type="text"
              class="form-input"
              id="updateCustomerAddress"
              placeholder="Nhập địa chỉ"
            />
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" id="cancelUpdateBtn">
            <i class="fas fa-times"></i>
            Hủy
          </button>
          <button class="btn btn-primary" id="saveUpdateBtn">
            <i class="fas fa-save"></i>
            Lưu
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteCustomerModal">
      <div class="modal-content">
        <button class="close-modal" id="closeDeleteModalBtn" title="Đóng">
          ×
        </button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-trash-alt"></i>
          </div>
          <h2 class="modal-title">Xác nhận xóa</h2>
        </div>

        <div class="modal-body">
          <p>
            Bạn có chắc chắn muốn xóa khách hàng
            <strong id="deleteCustomerName"></strong> không?
          </p>
          <p>Hành động này không thể hoàn tác.</p>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" id="cancelDeleteBtn">
            <i class="fas fa-times"></i>
            Hủy
          </button>
          <button class="btn btn-danger" id="confirmDeleteBtn">
            <i class="fas fa-trash-alt"></i>
            Xóa
          </button>
        </div>
      </div>
    </div>

    <!-- Profile Modal (tương tự dashboard.html) -->
    <div class="modal-overlay" id="profileModal">
      <div class="modal-content">
        <button class="close-modal" id="closeModalBtn" title="Đóng">×</button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-user"></i>
          </div>
          <h2 class="modal-title">Thông tin cá nhân</h2>
        </div>

        <div class="profile-section">
          <div class="section-title">
            <i class="fas fa-id-card"></i>
            Thông tin tài khoản
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tên đăng nhập</label>
              <input type="text" class="form-input" id="username" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">Vai trò</label>
              <input type="text" class="form-input" id="userRole" readonly />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="email" readonly />
          </div>

          <div class="form-group">
            <label class="form-label">Họ và tên</label>
            <input type="text" class="form-input" id="fullName" />
          </div>
        </div>

        <div class="profile-section password-section">
          <div class="section-title">
            <i class="fas fa-lock"></i>
            Đổi mật khẩu
          </div>

          <div class="form-group">
            <label class="form-label">Mật khẩu hiện tại</label>
            <input
              type="password"
              class="form-input"
              id="oldPassword"
              placeholder="Nhập mật khẩu hiện tại"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Mật khẩu mới</label>
              <input
                type="password"
                class="form-input"
                id="newPassword"
                placeholder="Nhập mật khẩu mới"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Xác nhận mật khẩu</label>
              <input
                type="password"
                class="form-input"
                id="confirmPassword"
                placeholder="Nhập lại mật khẩu mới"
              />
            </div>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="showPassword" />
            <label for="showPassword">Hiển thị mật khẩu</label>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" id="cancelBtn">
            <i class="fas fa-times"></i>
            Hủy
          </button>
          <button class="btn btn-primary" id="saveBtn">
            <i class="fas fa-save"></i>
            Cập nhật
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("🚀 Customers Management Page Loading...");

      // ===================== GLOBAL VARIABLES =====================
      let currentUser = null;
      let authToken = localStorage.getItem("token");
      let customersData = [];
      let currentCustomerId = null;

      // ===================== ENHANCED AUTHENTICATION =====================

      async function checkAuth(attempt = 1, maxAttempts = 3) {
        let authToken = localStorage.getItem("token");
        if (!authToken) {
          console.error("❌ No auth token found. Please login again.");
          showNotification(
            "Phiên đăng nhập đã hết. Vui lòng đăng nhập lại.",
            "error"
          );
          redirectToLogin();
          return false;
        }

        try {
          showLoading("Đang xác thực...");
          console.log(
            `🔍 Verifying authentication token (Attempt ${attempt}/${maxAttempts})`
          );
          const response = await fetch("/api/auth/verify", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
          });
          const result = await response.json();
          if (response.ok && result.success && result.user) {
            currentUser = result.user;
            updateUserInfo(result.user);
            console.log("✅ Authentication verified for:", result.user.name);
            return true;
          } else {
            throw new Error(
              result.error ||
                `HTTP ${response.status}: ${
                  result.message || "Invalid response"
                }`
            );
          }
        } catch (error) {
          console.error(
            `❌ Auth verification failed (Attempt ${attempt}):`,
            error.message
          );
          if (attempt < maxAttempts) {
            console.log(
              `🔄 Retrying authentication (${attempt + 1}/${maxAttempts})...`
            );
            await new Promise((resolve) => setTimeout(resolve, 1000));
            return checkAuth(attempt + 1, maxAttempts);
          }
          console.error(
            "❌ Max attempts reached. Clearing token and redirecting..."
          );
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          authToken = null;
          showNotification(
            `Phiên đăng nhập không hợp lệ: ${error.message}`,
            "error"
          );
          setTimeout(() => redirectToLogin(), 500);
          return false;
        } finally {
          hideLoading();
        }
      }

      function redirectToLogin() {
        console.log("🔄 Redirecting to login page");
        showNotification("Đang chuyển hướng đến trang đăng nhập...", "info");
        setTimeout(() => {
          window.location.href = "/login";
        }, 1000);
      }

      async function logout() {
        console.log("🚪 Logout started");
        const dropdownMenu = document.getElementById("dropdownMenu");
        if (dropdownMenu) {
          dropdownMenu.classList.remove("show");
        }
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        authToken = null;
        currentUser = null;
        console.log("🚪 Redirecting now...");
        window.location.href = "/login";
      }

      // ===================== USER INTERFACE UPDATES =====================

      function updateUserInfo(user) {
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");
        let displayName = user.fullName || user.name || user.username || "User";
        userName.textContent = displayName;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
        userAvatar.title = displayName;

        const usernameInput = document.getElementById("username");
        const userRoleInput = document.getElementById("userRole");
        const emailInput = document.getElementById("email");
        const fullNameInput = document.getElementById("fullName");

        if (usernameInput) usernameInput.value = user.username || "";
        if (userRoleInput) userRoleInput.value = capitalize(user.role || "");
        if (emailInput) emailInput.value = user.email || "";
        if (fullNameInput) fullNameInput.value = user.fullName || "";
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // ===================== APPLICATION INITIALIZATION =====================

      async function initApp() {
        console.log("🚀 Initializing Customers Page...");
        try {
          const isAuthenticated = await checkAuth();
          if (isAuthenticated) {
            console.log("✅ Authentication successful");
            await loadCustomersData();
            console.log("✅ Customers page initialized successfully!");
          } else {
            console.log("❌ Authentication failed - redirecting to login");
          }
        } catch (error) {
          console.error("❌ App initialization error:", error);
          showNotification("Lỗi khởi tạo ứng dụng", "error");
          setTimeout(() => redirectToLogin(), 2000);
        }
      }

      // ===================== CUSTOMERS DATA LOADING =====================

      async function loadCustomersData() {
        try {
          showLoading("Đang tải dữ liệu khách hàng...");
          const response = await fetch("/api/customers", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
          });
          const result = await response.json();
          console.log("API /api/customers response:", result);
          if (response.ok && result.success) {
            customersData = result.customers || [];
            updateCustomersTable(customersData);
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("Customers data error:", error);
          showNotification(
            `Không thể tải dữ liệu khách hàng: ${error.message}`,
            "error"
          );
          updateCustomersTable([]);
        } finally {
          hideLoading();
        }
      }

      function updateCustomersTable(customers) {
        const tbody = document.getElementById("customersTableBody");
        tbody.innerHTML = "";

        if (!customers || customers.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-database"></i>
                <h3>Không có khách hàng nào</h3>
                <p>Hiện tại chưa có dữ liệu khách hàng để hiển thị.</p>
              </td>
            </tr>`;
          return;
        }

        customers.forEach((customer) => {
          console.log("Rendering customer:", customer);
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="customer-id">#${customer.id
              .toString()
              .padStart(4, "0")}</td>
            <td class="customer-name">${customer.name || "N/A"}</td>
            <td>${customer.email || "N/A"}</td>
            <td>${customer.phone || "N/A"}</td>
            <td>${customer.address || "N/A"}</td>
            <td>${new Date(customer.created_at).toLocaleString("vi-VN")}</td>
            <td>
              <button class="action-btn view" data-customer-id="${
                customer.id
              }">Xem</button>
              <button class="action-btn edit" data-customer-id="${
                customer.id
              }">Cập nhật</button>
              <button class="action-btn delete" data-customer-id="${
                customer.id
              }">Xóa</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Gắn sự kiện cho các nút sau khi render
        const viewButtons = document.querySelectorAll(".action-btn.view");
        const editButtons = document.querySelectorAll(".action-btn.edit");
        const deleteButtons = document.querySelectorAll(".action-btn.delete");

        viewButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const customerId = parseInt(
              button.getAttribute("data-customer-id")
            );
            showCustomerDetails(customerId);
          });
        });

        editButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const customerId = parseInt(
              button.getAttribute("data-customer-id")
            );
            showUpdateCustomerModal(customerId);
          });
        });

        deleteButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const customerId = parseInt(
              button.getAttribute("data-customer-id")
            );
            showDeleteCustomerModal(customerId);
          });
        });
      }

      function showCustomerDetails(customerId) {
        console.log("🔍 Showing details for customer ID:", customerId);
        const customer = customersData.find((c) => c.id === customerId);
        if (!customer) {
          showNotification("Không tìm thấy khách hàng", "error");
          return;
        }

        document.getElementById("customerId").textContent = `#${customer.id
          .toString()
          .padStart(4, "0")}`;
        document.getElementById("customerName").textContent =
          customer.name || "N/A";
        document.getElementById("customerEmail").textContent =
          customer.email || "N/A";
        document.getElementById("customerPhone").textContent =
          customer.phone || "N/A";
        document.getElementById("customerAddress").textContent =
          customer.address || "N/A";
        document.getElementById("customerCreatedAt").textContent =
          new Date(customer.created_at).toLocaleString("vi-VN") || "N/A";

        document.getElementById("customerDetailsModal").classList.add("show");
      }

      function showUpdateCustomerModal(customerId) {
        console.log("✏️ Showing update modal for customer ID:", customerId);
        const customer = customersData.find((c) => c.id === customerId);
        if (!customer) {
          showNotification("Không tìm thấy khách hàng", "error");
          return;
        }

        currentCustomerId = customerId;
        document.getElementById("updateCustomerId").value = `#${customer.id
          .toString()
          .padStart(4, "0")}`;
        document.getElementById("updateCustomerName").value =
          customer.name || "";
        document.getElementById("updateCustomerEmail").value =
          customer.email || "";
        document.getElementById("updateCustomerPhone").value =
          customer.phone || "";
        document.getElementById("updateCustomerAddress").value =
          customer.address || "";

        document.getElementById("updateCustomerModal").classList.add("show");
      }

      async function saveCustomerUpdate() {
        console.log("💾 Saving customer update for ID:", currentCustomerId);
        const name = document.getElementById("updateCustomerName").value.trim();
        const email = document
          .getElementById("updateCustomerEmail")
          .value.trim();
        const phone = document
          .getElementById("updateCustomerPhone")
          .value.trim();
        const address = document
          .getElementById("updateCustomerAddress")
          .value.trim();

        if (!name) {
          showNotification("Tên khách hàng không được để trống", "error");
          return;
        }

        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showNotification("Email không hợp lệ", "error");
          return;
        }

        if (phone && !/^\d{10,11}$/.test(phone)) {
          showNotification("Số điện thoại không hợp lệ", "error");
          return;
        }

        try {
          showLoading("Đang cập nhật khách hàng...");
          const response = await fetch(`/api/customers/${currentCustomerId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, email, phone, address }),
          });

          const result = await response.json();
          if (response.ok && result.success) {
            showNotification("Cập nhật khách hàng thành công", "success");
            await loadCustomersData();
            document
              .getElementById("updateCustomerModal")
              .classList.remove("show");
          } else {
            throw new Error(result.error || "Cập nhật thất bại");
          }
        } catch (error) {
          console.error("Update customer error:", error);
          showNotification(`Lỗi: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      function showDeleteCustomerModal(customerId) {
        console.log("🗑️ Showing delete modal for customer ID:", customerId);
        const customer = customersData.find((c) => c.id === customerId);
        if (!customer) {
          showNotification("Không tìm thấy khách hàng", "error");
          return;
        }

        currentCustomerId = customerId;
        document.getElementById("deleteCustomerName").textContent =
          customer.name || "N/A";
        document.getElementById("deleteCustomerModal").classList.add("show");
      }

      async function deleteCustomer() {
        console.log("🗑️ Deleting customer ID:", currentCustomerId);
        try {
          showLoading("Đang xóa khách hàng...");
          const response = await fetch(`/api/customers/${currentCustomerId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (response.ok && result.success) {
            showNotification("Xóa khách hàng thành công", "success");
            await loadCustomersData();
            document
              .getElementById("deleteCustomerModal")
              .classList.remove("show");
          } else {
            throw new Error(result.error || "Xóa thất bại");
          }
        } catch (error) {
          console.error("Delete customer error:", error);
          showNotification(`Lỗi: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      // ===================== NOTIFICATION AND LOADING =====================

      function showNotification(message, type = "success", duration = 4000) {
        const existingNotifications =
          document.querySelectorAll(".notification");
        existingNotifications.forEach((notification) => notification.remove());

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        const icons = {
          success: "check-circle",
          error: "exclamation-triangle",
          warning: "exclamation-circle",
          info: "info-circle",
        };
        notification.innerHTML = `
          <i class="fas fa-${icons[type] || icons.info}"></i>
          ${message}
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.4s ease forwards";
          setTimeout(() => notification.remove(), 400);
        }, duration);
      }

      function showLoading(message = "Đang tải...") {
        const overlay = document.getElementById("loadingOverlay");
        const text = overlay.querySelector(".loading-text");
        if (text) text.textContent = message;
        overlay.classList.add("show");
      }

      function hideLoading() {
        const overlay = document.getElementById("loadingOverlay");
        overlay.classList.remove("show");
      }

      // ===================== EVENT HANDLERS =====================

      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");
          const page = item.getAttribute("data-page");
          if (page && page !== "customers") {
            window.location.href = item.href;
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        console.log("📅 DOM fully loaded and parsed");

        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("🚪 Logout button clicked");
            logout();
          });
        }

        const profileBtn = document.getElementById("profileBtn");
        if (profileBtn) {
          profileBtn.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("👤 Profile button clicked");
            viewProfile();
          });
        }

        const closeModalBtn = document.getElementById("closeModalBtn");
        if (closeModalBtn) {
          closeModalBtn.addEventListener("click", (e) => {
            console.log("❌ Close profile modal");
            closeProfileModal();
          });
        }

        const closeCustomerModalBtn = document.getElementById(
          "closeCustomerModalBtn"
        );
        if (closeCustomerModalBtn) {
          closeCustomerModalBtn.addEventListener("click", () => {
            console.log("❌ Closing customer details modal");
            document
              .getElementById("customerDetailsModal")
              .classList.remove("show");
          });
        }

        const closeUpdateModalBtn = document.getElementById(
          "closeUpdateModalBtn"
        );
        if (closeUpdateModalBtn) {
          closeUpdateModalBtn.addEventListener("click", () => {
            console.log("❌ Closing update customer modal");
            document
              .getElementById("updateCustomerModal")
              .classList.remove("show");
          });
        }

        const closeDeleteModalBtn = document.getElementById(
          "closeDeleteModalBtn"
        );
        if (closeDeleteModalBtn) {
          closeDeleteModalBtn.addEventListener("click", () => {
            console.log("❌ Closing delete customer modal");
            document
              .getElementById("deleteCustomerModal")
              .classList.remove("show");
          });
        }

        const cancelUpdateBtn = document.getElementById("cancelUpdateBtn");
        if (cancelUpdateBtn) {
          cancelUpdateBtn.addEventListener("click", () => {
            console.log("🚫 Cancel update customer");
            document
              .getElementById("updateCustomerModal")
              .classList.remove("show");
          });
        }

        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        if (cancelDeleteBtn) {
          cancelDeleteBtn.addEventListener("click", () => {
            console.log("🚫 Cancel delete customer");
            document
              .getElementById("deleteCustomerModal")
              .classList.remove("show");
          });
        }

        const saveUpdateBtn = document.getElementById("saveUpdateBtn");
        if (saveUpdateBtn) {
          saveUpdateBtn.addEventListener("click", () => {
            console.log("💾 Save update button clicked");
            saveCustomerUpdate();
          });
        }

        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener("click", () => {
            console.log("🗑️ Confirm delete button clicked");
            deleteCustomer();
          });
        }

        const cancelBtn = document.getElementById("cancelBtn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", (e) => {
            console.log("🚫 Cancel button clicked");
            closeProfileModal();
          });
        }

        const saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
          saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("💾 Save profile");
            saveProfile();
          });
        }

        const customerModal = document.getElementById("customerDetailsModal");
        if (customerModal) {
          customerModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              customerModal.classList.remove("show");
            }
          });
        }

        const updateModal = document.getElementById("updateCustomerModal");
        if (updateModal) {
          updateModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              updateModal.classList.remove("show");
            }
          });
        }

        const deleteModal = document.getElementById("deleteCustomerModal");
        if (deleteModal) {
          deleteModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              deleteModal.classList.remove("show");
            }
          });
        }

        const profileModal = document.getElementById("profileModal");
        if (profileModal) {
          profileModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              closeProfileModal();
            }
          });
        }
      });

      const settingsBtn = document.getElementById("settingsBtn");
      const dropdownMenu = document.getElementById("dropdownMenu");
      if (settingsBtn && dropdownMenu) {
        settingsBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          dropdownMenu.classList.toggle("show");
          console.log("⚙️ Settings dropdown toggled");
        });
      }

      document.addEventListener("click", (e) => {
        if (
          settingsBtn &&
          dropdownMenu &&
          !settingsBtn.contains(e.target) &&
          !dropdownMenu.contains(e.target)
        ) {
          dropdownMenu.classList.remove("show");
        }
      });

      // ===================== PROFILE MODAL FUNCTIONS =====================

      function viewProfile() {
        const dropdownMenuElement = document.getElementById("dropdownMenu");
        dropdownMenuElement.classList.remove("show");

        console.log("Opening profile modal for user:", currentUser);

        if (currentUser) {
          updateUserInfo(currentUser);
        } else {
          loadCurrentUserInfo();
        }

        document.getElementById("profileModal").classList.add("show");
      }

      async function loadCurrentUserInfo() {
        try {
          const response = await fetch("/api/auth/me", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.user) {
              currentUser = result.user;
              updateUserInfo(result.user);
            }
          }
        } catch (error) {
          console.error("❌ Failed to load user info:", error);
        }
      }

      function closeProfileModal() {
        document.getElementById("profileModal").classList.remove("show");
        const oldPassword = document.getElementById("oldPassword");
        const newPassword = document.getElementById("newPassword");
        const confirmPassword = document.getElementById("confirmPassword");

        if (oldPassword) oldPassword.value = "";
        if (newPassword) newPassword.value = "";
        if (confirmPassword) confirmPassword.value = "";
      }

      async function saveProfile() {
        const saveProfileModal = document.getElementById("profileModal");
        const oldPassword = document.getElementById("oldPassword").value.trim();
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document
          .getElementById("confirmPassword")
          .value.trim();
        const fullName = document.getElementById("fullName").value.trim();

        const hasPasswordChanges =
          oldPassword || newPassword || confirmPassword;
        const hasNameChanges = fullName !== (currentUser?.fullName || "");

        if (!hasPasswordChanges && !hasNameChanges) {
          showNotification("Không có thay đổi nào để lưu", "info");
          return;
        }

        if (hasPasswordChanges) {
          if (!oldPassword) {
            showNotification("Vui lòng nhập mật khẩu hiện tại", "error");
            return;
          }
          if (!newPassword) {
            showNotification("Vui lòng nhập mật khẩu mới", "error");
            return;
          }
          if (newPassword !== confirmPassword) {
            showNotification("Mật khẩu xác nhận không khớp", "error");
            return;
          }
          if (newPassword.length < 6) {
            showNotification("Mật khẩu mới phải có ít nhất 6 ký tự", "error");
            return;
          }
        }

        try {
          showLoading("Đang cập nhật...");
          const updateData = {};
          if (hasPasswordChanges) {
            updateData.oldPassword = oldPassword;
            updateData.newPassword = newPassword;
          }
          if (hasNameChanges) {
            updateData.fullName = fullName;
          }

          const response = await fetch("/api/auth/update-profile", {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showNotification("Cập nhật thông tin thành công!", "success");
            if (result.user) {
              currentUser = result.user;
              updateUserInfo(result.user);
            }
            closeProfileModal();
          } else {
            showNotification(result.error || "Cập nhật thất bại", "error");
          }
        } catch (error) {
          console.error("Profile update error:", error);
          showNotification("Lỗi kết nối. Vui lòng thử lại!", "error");
        } finally {
          hideLoading();
        }
      }

      const showPasswordCheckbox = document.getElementById("showPassword");
      if (showPasswordCheckbox) {
        showPasswordCheckbox.addEventListener("change", (e) => {
          const passwordInputs = [
            document.getElementById("oldPassword"),
            document.getElementById("newPassword"),
            document.getElementById("confirmPassword"),
          ];

          passwordInputs.forEach((input) => {
            if (input) {
              input.type = e.target.checked ? "text" : "password";
            }
          });
        });
      }

      // ===================== SECURITY & LIFECYCLE MANAGEMENT =====================

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && authToken) {
          checkAuth();
        }
      });

      setInterval(() => {
        if (authToken && !document.hidden) {
          checkAuth();
        }
      }, 5 * 60 * 1000);

      window.addEventListener("popstate", (e) => {
        if (!authToken) {
          window.location.href = "/login";
        }
      });

      window.addEventListener("pageshow", (e) => {
        if (e.persisted && !authToken) {
          window.location.href = "/login";
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeProfileModal();
          document
            .getElementById("customerDetailsModal")
            .classList.remove("show");
          document
            .getElementById("updateCustomerModal")
            .classList.remove("show");
          document
            .getElementById("deleteCustomerModal")
            .classList.remove("show");
          const dropdownMenu = document.getElementById("dropdownMenu");
          if (dropdownMenu) {
            dropdownMenu.classList.remove("show");
          }
        }
      });

      // ===================== APPLICATION STARTUP =====================

      document.addEventListener("DOMContentLoaded", initApp);

      setInterval(() => {
        if (authToken && !document.hidden) {
          loadCustomersData();
        }
      }, 5 * 60 * 1000);

      console.log("✅ Customers Management Page loaded");
    </script>
  </body>
</html>
