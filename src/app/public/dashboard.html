<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Sales Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 10px;
        font-size: 22px;
      }

      .nav-menu {
        display: flex;
        gap: 25px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        color: white;
        font-weight: 500;
        position: relative;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 600;
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #f0f0f0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #667eea;
        font-size: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .settings-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 120%;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 220px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-15px);
        transition: all 0.4s ease;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .dropdown-item:hover {
        background: #f8f9fa;
      }

      .dropdown-item:first-child {
        border-bottom: 1px solid #eee;
      }

      .dropdown-item:first-child:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .dropdown-item:last-child:hover {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      .dropdown-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
        min-height: calc(100vh - 80px);
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .page-subtitle {
        color: #7f8c8d;
        font-size: 16px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #667eea, #764ba2);
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .stat-title {
        font-size: 15px;
        color: #7f8c8d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 36px;
        font-weight: bold;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .stat-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #667eea;
      }

      .chart-container {
        height: 180px;
        margin-top: 20px;
        position: relative;
      }

      /* Transactions Section */
      .transactions-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .section-header {
        padding: 25px 30px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .transactions-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .transactions-table th,
      .transactions-table td {
        padding: 18px 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #666;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .transactions-table th {
        background: #f8f9fa;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #eee;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .transactions-table th:nth-child(1),
      .transactions-table td:nth-child(1) {
        width: 10%;
      }

      .transactions-table th:nth-child(2),
      .transactions-table td:nth-child(2) {
        width: 15%;
      }

      .transactions-table th:nth-child(3),
      .transactions-table td:nth-child(3) {
        width: 25%;
      }

      .transactions-table th:nth-child(4),
      .transactions-table td:nth-child(4) {
        width: 10%;
        text-align: center;
      }

      .transactions-table th:nth-child(5),
      .transactions-table td:nth-child(5) {
        width: 15%;
        text-align: right;
      }

      .transactions-table th:nth-child(6),
      .transactions-table td:nth-child(6) {
        width: 12%;
        text-align: center;
      }

      .transactions-table th:nth-child(7),
      .transactions-table td:nth-child(7) {
        width: 13%;
      }

      @media (max-width: 768px) {
        .transactions-table th,
        .transactions-table td {
          padding: 12px 8px;
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .transactions-table th,
        .transactions-table td {
          padding: 10px 5px;
          font-size: 11px;
        }
      }

      .transactions-table tr:hover {
        background: #f8f9fa;
      }

      .order-id {
        font-weight: 600;
        color: #333;
        font-family: "Courier New", monospace;
      }

      .amount {
        font-weight: 700;
        color: #27ae60;
        font-size: 15px;
      }

      .customer-name {
        font-weight: 500;
        color: #2c3e50;
      }

      /* Status badges */
      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-delivered {
        background: #d4edda;
        color: #155724;
      }

      .status-shipped {
        background: #cce7ff;
        color: #004085;
      }

      .status-processing {
        background: #fff3cd;
        color: #856404;
      }

      .status-pending {
        background: #f8d7da;
        color: #721c24;
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s ease;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 35px;
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.4s ease;
        position: relative;
      }

      .modal-overlay.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
      }

      .modal-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .profile-section {
        margin-bottom: 25px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: #f9f9f9;
        color: #666;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .password-section {
        border-top: 1px solid #eee;
        padding-top: 25px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #666;
      }

      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 25px;
        border-top: 1px solid #eee;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #e9e9e9;
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-modal:hover {
        background: #f0f0f0;
        color: #666;
      }

      /* Notification styles */
      .notification {
        position: fixed;
        top: 25px;
        right: 25px;
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        z-index: 3000;
        animation: slideInRight 0.4s ease;
        max-width: 350px;
        font-weight: 500;
      }

      .notification.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .notification.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .notification.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .notification.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #667eea;
        font-weight: 600;
        font-size: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: #7f8c8d;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #bdc3c7;
      }

      .empty-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #95a5a6;
      }

      .empty-state p {
        font-size: 14px;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .nav-menu {
          gap: 15px;
        }

        .nav-item {
          padding: 8px 12px;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 15px 20px;
        }

        .nav-menu {
          display: none;
        }

        .logo {
          font-size: 20px;
        }

        .main-content {
          padding: 20px 15px;
        }

        .page-title {
          font-size: 24px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .transactions-table {
          font-size: 13px;
        }

        .transactions-table th,
        .transactions-table td {
          padding: 12px 15px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .modal-content {
          padding: 25px 20px;
          margin: 20px;
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 5px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      .modal-body table {
        width: 100%;
        margin-top: 10px;
      }

      .modal-body th,
      .modal-body td {
        padding: 8px;
        text-align: left;
      }

      @media (max-width: 480px) {
        .header {
          padding: 12px 15px;
        }

        .user-info {
          gap: 8px;
        }

        .user-name {
          display: none;
        }

        .main-content {
          padding: 15px 10px;
        }

        .stat-card {
          padding: 20px;
        }

        .section-header {
          padding: 20px;
        }

        .transactions-table th,
        .transactions-table td {
          padding: 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div id="orderDetailsModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div class="modal-body"></div>
      </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <header class="header">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>Sales Management System</span>
      </div>

      <nav class="nav-menu">
        <a href="/dashboard" class="nav-item active" data-page="dashboard">
          <i class="fas fa-home"></i>
          T·ªïng quan
        </a>
        <a href="/products-page" class="nav-item" data-page="products">
          <i class="fas fa-box"></i>
          S·∫£n ph·∫©m
        </a>
        <a href="/customers-page" class="nav-item" data-page="customers">
          <i class="fas fa-users"></i>
          Kh√°ch h√†ng
        </a>
        <a href="/orders-page" class="nav-item" data-page="orders">
          <i class="fas fa-shopping-cart"></i>
          ƒê∆°n h√†ng
        </a>
        <a href="/statistics-page" class="nav-item" data-page="statistics">
          <i class="fas fa-chart-bar"></i>
          Th·ªëng K√™
        </a>
      </nav>

      <div class="user-info">
        <span class="user-name" id="userName">ƒêang t·∫£i...</span>
        <div class="user-avatar" id="userAvatar" title="Thong Ã£tin c√° nh√¢n">
          ?
        </div>
        <button class="settings-btn" id="settingsBtn" title="C√†i ƒë·∫∑t">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <button class="dropdown-item" id="profileBtn">
            <i class="fas fa-user dropdown-icon"></i>
            Th√¥ng tin c√° nh√¢n
          </button>
          <button class="dropdown-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt dropdown-icon"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">T·ªïng quan h·ªá th·ªëng qu·∫£n l√Ω b√°n h√†ng</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">S·∫£n ph·∫©m b√°n ra</span>
            <div class="stat-icon">
              <i class="fas fa-box"></i>
            </div>
          </div>
          <div class="stat-value" id="productsCount">134</div>
          <div class="chart-container">
            <canvas id="chart1"></canvas>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Doanh thu</span>
            <div class="stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
          </div>
          <div class="stat-value" id="revenueCount">780k</div>
          <div class="chart-container">
            <canvas id="chart2"></canvas>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">T·ªïng s·ªë ng∆∞·ªùi d√πng</span>
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
          <div class="stat-value" id="usersCount">275</div>
          <div class="chart-container">
            <canvas id="chart3"></canvas>
          </div>
        </div>
      </div>

      <div class="transactions-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-history"></i>
            L·ªãch s·ª≠ giao d·ªãch g·∫ßn ƒë√¢y
          </h2>
        </div>

        <table class="transactions-table">
          <thead>
            <tr>
              <th>M√£ ƒë∆°n h√†ng</th>
              <th>Kh√°ch h√†ng</th>
              <th>S·∫£n ph·∫©m</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y t·∫°o</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-database"></i>
                <h3>Kh√¥ng c√≥ giao d·ªãch n√†o</h3>
                <p>Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu giao d·ªãch ƒë·ªÉ hi·ªÉn th·ªã.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
      <div class="modal-content">
        <button class="close-modal" id="closeModalBtn" title="ƒê√≥ng">√ó</button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-user"></i>
          </div>
          <h2 class="modal-title">Th√¥ng tin c√° nh√¢n</h2>
        </div>

        <div class="profile-section">
          <div class="section-title">
            <i class="fas fa-id-card"></i>
            Th√¥ng tin t√†i kho·∫£n
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input type="text" class="form-input" id="username" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">Vai tr√≤</label>
              <input type="text" class="form-input" id="userRole" readonly />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="email" readonly />
          </div>

          <div class="form-group">
            <label class="form-label">H·ªç v√† t√™n</label>
            <input type="text" class="form-input" id="fullName" />
          </div>
        </div>

        <div class="profile-section password-section">
          <div class="section-title">
            <i class="fas fa-lock"></i>
            ƒê·ªïi m·∫≠t kh·∫©u
          </div>

          <div class="form-group">
            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input
              type="password"
              class="form-input"
              id="oldPassword"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                class="form-input"
                id="newPassword"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
              />
            </div>
            <div class="form-group">
              <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
              <input
                type="password"
                class="form-input"
                id="confirmPassword"
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
              />
            </div>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="showPassword" />
            <label for="showPassword">Hi·ªÉn th·ªã m·∫≠t kh·∫©u</label>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" id="cancelBtn">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button class="btn btn-primary" id="saveBtn">
            <i class="fas fa-save"></i>
            C·∫≠p nh·∫≠t
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("üöÄ Sales Management Dashboard Loading...");

      // ===================== GLOBAL VARIABLES =====================
      let currentUser = null;
      let authToken = localStorage.getItem("authToken");
      let dashboardCharts = {};
      let dashboardData = null; // ‚úÖ FIX: Khai b√°o bi·∫øn n√†y

      // Enhanced chart data
      const enhancedChartData = {
        products: [
          45, 48, 52, 49, 58, 65, 69, 73, 78, 85, 95, 102, 118, 125, 134,
        ],
        revenue: [
          180, 195, 210, 225, 280, 320, 380, 420, 480, 550, 620, 680, 720, 750,
          780,
        ],
        users: [
          95, 105, 110, 120, 135, 150, 168, 180, 195, 210, 230, 245, 260, 270,
          275,
        ],
      };

      const chartLabels = [
        1, 3, 5, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40,
      ];

      // ===================== ERROR HANDLING =====================
      function handleInitError(error) {
        console.error("üö® Critical initialization error:", error);

        // Clear potentially corrupted auth data
        localStorage.removeItem("authToken");
        localStorage.removeItem("user");

        // Show user-friendly error
        showNotification(
          "L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng. ƒêang chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p...",
          "error"
        );

        // Redirect after delay
        setTimeout(() => {
          window.location.href = "/login";
        }, 2000);
      }

      // ===================== AUTHENTICATION =====================
      async function checkAuth() {
        if (!authToken) {
          console.log("‚ùå No auth token found");
          redirectToLogin();
          return false;
        }

        try {
          showLoading("ƒêang x√°c th·ª±c...");
          console.log("üîç Verifying authentication token");

          const response = await fetch("/api/auth/verify", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
            signal: AbortSignal.timeout(10000), // ‚úÖ FIX: Add timeout
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.user) {
              currentUser = result.user;
              updateUserInfo(result.user);
              console.log("‚úÖ Authentication verified for:", result.user.name);
              return true;
            } else {
              throw new Error("Invalid response format");
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Auth verification failed:", error);

          // Clear invalid authentication data
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          authToken = null;

          if (error.name !== "AbortError") {
            showNotification("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n", "warning");
          }

          setTimeout(() => {
            redirectToLogin();
          }, 1000);

          return false;
        } finally {
          hideLoading();
        }
      }

      function redirectToLogin() {
        console.log("üîÑ Redirecting to login page");
        showNotification("ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...", "info");

        setTimeout(() => {
          window.location.href = "/login";
        }, 1000);
      }

      async function logout() {
        console.log("üö™ Logout started");

        // Close dropdown
        const dropdownMenu = document.getElementById("dropdownMenu");
        if (dropdownMenu) {
          dropdownMenu.classList.remove("show");
        }

        // Clear local data
        localStorage.removeItem("authToken");
        localStorage.removeItem("user");
        authToken = null;
        currentUser = null;

        console.log("üö™ Redirecting to login...");
        window.location.href = "/login";
      }

      // ===================== USER INTERFACE UPDATES =====================
      function updateUserInfo(user) {
        try {
          if (!user) {
            console.warn("‚ö†Ô∏è updateUserInfo called with null user");
            return;
          }

          const userName = document.getElementById("userName");
          const userAvatar = document.getElementById("userAvatar");

          let displayName =
            user.fullName || user.name || user.username || "User";

          if (userName) userName.textContent = displayName;
          if (userAvatar) {
            userAvatar.textContent = displayName.charAt(0).toUpperCase();
            userAvatar.title = displayName;
          }

          // Update profile form if exists
          const usernameInput = document.getElementById("username");
          const userRoleInput = document.getElementById("userRole");
          const emailInput = document.getElementById("email");
          const fullNameInput = document.getElementById("fullName");

          if (usernameInput) usernameInput.value = user.username || "";
          if (userRoleInput) userRoleInput.value = capitalize(user.role || "");
          if (emailInput) emailInput.value = user.email || "";
          if (fullNameInput) fullNameInput.value = user.fullName || "";
        } catch (error) {
          console.error("‚ùå Error updating user info:", error);
        }
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // ===================== DASHBOARD DATA LOADING =====================
      async function loadDashboardData() {
        try {
          showLoading("ƒêang t·∫£i d·ªØ li·ªáu dashboard...");

          // ‚úÖ FIX: Initialize dashboardData object first
          dashboardData = {
            stats: { products: 134, revenue: "780k", users: 275 },
            orders: [],
            charts: enhancedChartData,
          };

          // Load orders from API (not database directly!)
          const response = await fetch("/api/orders", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
            signal: AbortSignal.timeout(15000), // ‚úÖ FIX: Add timeout
          });

          if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ Orders API response:", result);

            if (result.success) {
              dashboardData.orders = result.orders || [];
              updateStats(dashboardData.stats);
              updateCharts(dashboardData.charts);
              await updateTransactions(result);
            } else {
              throw new Error(result.error || "Invalid API response");
            }
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.error("‚ùå Dashboard data loading error:", error);

          // Use fallback data
          console.log("üîÑ Using fallback dashboard data");
          updateStats(
            dashboardData?.stats || {
              products: 134,
              revenue: "780k",
              users: 275,
            }
          );
          updateCharts(dashboardData?.charts || enhancedChartData);
          updateTransactions({ orders: [] });

          if (error.name !== "AbortError") {
            showNotification(
              `M·ªôt s·ªë d·ªØ li·ªáu kh√¥ng th·ªÉ t·∫£i: ${error.message}`,
              "warning"
            );
          }
        } finally {
          hideLoading();
        }
      }

      // ‚úÖ FIX: Remove database-related functions from frontend
      async function updateTransactions(data) {
        const tbody = document.getElementById("transactionsTableBody");
        tbody.innerHTML = "";

        console.log("üîÑ updateTransactions called with data:", data);

        if (!data.orders || data.orders.length === 0) {
          tbody.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          <i class="fas fa-database"></i>
          <h3>Kh√¥ng c√≥ giao d·ªãch n√†o</h3>
          <p>Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu giao d·ªãch ƒë·ªÉ hi·ªÉn th·ªã.</p>
        </td>
      </tr>`;
          return;
        }

        console.log(`üìä Processing ${data.orders.length} orders`);

        // Process each order
        for (const order of data.orders) {
          try {
            const orderIdForAPI = order.id || order.order_id?.replace("#", "");

            const response = await fetch(
              `/api/orders/${orderIdForAPI}/details`,
              {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
              }
            );

            if (response.ok) {
              const result = await response.json();

              if (result.success && result.order) {
                const orderDetails = result.order;
                const items = orderDetails.items || [];

                // Calculate product info
                const productNames =
                  items.length > 0
                    ? items
                        .map(
                          (item) => `${item.product_name} (${item.quantity})`
                        )
                        .join(", ")
                    : "Kh√¥ng c√≥ s·∫£n ph·∫©m";

                const totalQuantity = items.reduce(
                  (sum, item) => sum + (item.quantity || 0),
                  0
                );

                // Create table row
                const row = document.createElement("tr");
                row.style.cursor = "pointer";
                row.innerHTML = `
            <td class="order-id">${order.order_id}</td>
            <td class="customer-name">${order.customer_name || "Unknown"}</td>
            <td title="${productNames}">${
                  productNames.length > 50
                    ? productNames.substring(0, 50) + "..."
                    : productNames
                }</td>
            <td style="text-align: center;">${totalQuantity || 0}</td>
            <td class="amount">${(order.total_amount || 0).toLocaleString(
              "vi-VN"
            )} ƒë</td>
            <td><span class="status-badge status-${order.status
              .toLowerCase()
              .replace(/\s+/g, "-")}">${order.status}</span></td>
            <td>${new Date(order.created_at).toLocaleString("vi-VN")}</td>
          `;

                // Add click event for details
                row.addEventListener("click", () =>
                  showOrderDetails(order.order_id)
                );
                tbody.appendChild(row);

                console.log(`‚úÖ Added order ${order.order_id} to table`);
              }
            } else {
              console.error(
                `‚ùå Failed to fetch details for order ${order.order_id}`
              );
              addSimpleOrderRow(order, tbody);
            }
          } catch (error) {
            console.error(
              `‚ùå Error processing order ${order.order_id}:`,
              error
            );
            addSimpleOrderRow(order, tbody);
          }
        }

        console.log("‚úÖ updateTransactions completed");
      }

      function addSimpleOrderRow(order, tbody) {
        const row = document.createElement("tr");
        row.style.cursor = "pointer";
        row.innerHTML = `
    <td class="order-id">${order.order_id}</td>
    <td class="customer-name">${order.customer_name || "Unknown"}</td>
    <td>ƒêang t·∫£i...</td>
    <td style="text-align: center;">-</td>
    <td class="amount">${(order.total_amount || 0).toLocaleString(
      "vi-VN"
    )} ƒë</td>
    <td><span class="status-badge status-${order.status
      .toLowerCase()
      .replace(/\s+/g, "-")}">${order.status}</span></td>
    <td>${new Date(order.created_at).toLocaleString("vi-VN")}</td>
  `;

        row.addEventListener("click", () => showOrderDetails(order.order_id));
        tbody.appendChild(row);
      }

      async function showOrderDetails(orderId) {
        try {
          console.log(`üîç Showing details for order: ${orderId}`);

          const orderIdForAPI = orderId.replace("#", "");
          const response = await fetch(`/api/orders/${orderIdForAPI}/details`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          if (!data.success) {
            showNotification(
              data.error || "Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng",
              "error"
            );
            return;
          }

          const modal = document.getElementById("orderDetailsModal");
          const modalBody = modal.querySelector(".modal-body");
          const order = data.order;

          modalBody.innerHTML = `
      <h5>Chi ti·∫øt ƒë∆°n h√†ng ${order.order_id}</h5>
      <div style="margin-bottom: 20px;">
        <p><strong>Kh√°ch h√†ng:</strong> ${order.customer_name}</p>
        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${order.customer_phone}</p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.customer_address}</p>
        <p><strong>T·ªïng ti·ªÅn:</strong> <span style="color: #27ae60; font-weight: bold;">${order.total_amount.toLocaleString(
          "vi-VN"
        )} ƒë</span></p>
        <p><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge status-${order.status
          .toLowerCase()
          .replace(/\s+/g, "-")}">${order.status}</span></p>
        <p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(
          order.order_date
        ).toLocaleString("vi-VN")}</p>
        ${
          order.delivery_date
            ? `<p><strong>Ng√†y giao:</strong> ${new Date(
                order.delivery_date
              ).toLocaleString("vi-VN")}</p>`
            : ""
        }
        ${order.notes ? `<p><strong>Ghi ch√∫:</strong> ${order.notes}</p>` : ""}
      </div>
      
      <h6>Danh s√°ch s·∫£n ph·∫©m:</h6>
      <table class="table table-bordered" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa;">
            <th style="padding: 12px; border: 1px solid #ddd;">S·∫£n ph·∫©m</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">S·ªë l∆∞·ª£ng</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">ƒê∆°n gi√°</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody>
          ${order.items
            .map(
              (item) => `
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd;">
                <div><strong>${item.product_name}</strong></div>
                <div style="font-size: 12px; color: #666;">M√£: ${
                  item.product_code
                }</div>
              </td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${
                item.quantity
              }</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${item.unit_price.toLocaleString(
                "vi-VN"
              )} ƒë</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold;">${item.total_price.toLocaleString(
                "vi-VN"
              )} ƒë</td>
            </tr>
          `
            )
            .join("")}
        </tbody>
        <tfoot>
          <tr style="background-color: #f8f9fa; font-weight: bold;">
            <td colspan="3" style="padding: 12px; border: 1px solid #ddd; text-align: right;">T·ªïng c·ªông:</td>
            <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #27ae60;">${order.total_amount.toLocaleString(
              "vi-VN"
            )} ƒë</td>
          </tr>
        </tfoot>
      </table>
    `;

          modal.style.display = "block";
          console.log(`‚úÖ Order details modal shown for ${orderId}`);
        } catch (error) {
          console.error("Error fetching order details:", error);
          showNotification("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng", "error");
        }
      }

      // ===================== APPLICATION INITIALIZATION =====================
      async function initApp() {
        console.log("üöÄ Initializing Sales Management Dashboard...");

        try {
          // Step 1: Check authentication
          console.log("Step 1: Authenticating...");
          const isAuthenticated = await checkAuth();

          if (!isAuthenticated) {
            console.log("‚ùå Authentication failed");
            return; // checkAuth already handles redirect
          }

          console.log("‚úÖ Authentication successful");

          // Step 2: Setup event listeners
          console.log("Step 2: Setting up event listeners...");
          setupEventListeners();

          // Step 3: Load dashboard data
          console.log("Step 3: Loading dashboard data...");
          await loadDashboardData();

          console.log("‚úÖ Dashboard initialized successfully!");
        } catch (error) {
          console.error("‚ùå App initialization error:", error);
          throw error; // Re-throw to be handled by caller
        }
      }

      function setupEventListeners() {
        try {
          // Settings dropdown
          const settingsBtn = document.getElementById("settingsBtn");
          const dropdownMenu = document.getElementById("dropdownMenu");

          if (settingsBtn && dropdownMenu) {
            settingsBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdownMenu.classList.toggle("show");
            });
          }

          // Profile and logout buttons
          const profileBtn = document.getElementById("profileBtn");
          const logoutBtn = document.getElementById("logoutBtn");

          if (profileBtn) {
            profileBtn.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              viewProfile();
            });
          }

          if (logoutBtn) {
            logoutBtn.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              logout();
            });
          }

          // Modal buttons
          const closeModalBtn = document.getElementById("closeModalBtn");
          const cancelBtn = document.getElementById("cancelBtn");
          const saveBtn = document.getElementById("saveBtn");

          if (closeModalBtn) {
            closeModalBtn.addEventListener("click", (e) => {
              e.preventDefault();
              closeProfileModal();
            });
          }

          if (cancelBtn) {
            cancelBtn.addEventListener("click", (e) => {
              e.preventDefault();
              closeProfileModal();
            });
          }

          if (saveBtn) {
            saveBtn.addEventListener("click", (e) => {
              e.preventDefault();
              saveProfile();
            });
          }

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (settingsBtn && dropdownMenu) {
              if (
                !settingsBtn.contains(e.target) &&
                !dropdownMenu.contains(e.target)
              ) {
                dropdownMenu.classList.remove("show");
              }
            }
          });

          // Order details modal
          const orderModal = document.getElementById("orderDetailsModal");
          const orderCloseBtn = orderModal?.querySelector(".close");

          if (orderCloseBtn) {
            orderCloseBtn.addEventListener("click", () => {
              orderModal.style.display = "none";
            });
          }

          if (orderModal) {
            window.addEventListener("click", (event) => {
              if (event.target === orderModal) {
                orderModal.style.display = "none";
              }
            });
          }

          console.log("‚úÖ Event listeners setup completed");
        } catch (error) {
          console.error("‚ùå Error setting up event listeners:", error);
        }
      }

      // ===================== UI HELPER FUNCTIONS =====================
      function updateStats(data) {
        const productsCount = document.getElementById("productsCount");
        const revenueCount = document.getElementById("revenueCount");
        const usersCount = document.getElementById("usersCount");

        if (productsCount) productsCount.textContent = data.products || 134;
        if (revenueCount) revenueCount.textContent = data.revenue || "780k";
        if (usersCount) usersCount.textContent = data.users || 275;
      }

      function showNotification(message, type = "info", duration = 5000) {
        try {
          // Remove existing notifications
          const existingNotifications =
            document.querySelectorAll(".notification");
          existingNotifications.forEach((notification) => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          });

          const notification = document.createElement("div");
          notification.className = `notification ${type}`;

          const icons = {
            success: "check-circle",
            error: "exclamation-triangle",
            warning: "exclamation-circle",
            info: "info-circle",
          };

          notification.innerHTML = `
      <i class="fas fa-${icons[type] || icons.info}"></i>
      ${message}
    `;

          document.body.appendChild(notification);

          // Auto remove
          setTimeout(() => {
            if (notification.parentNode) {
              notification.style.animation = "slideOutRight 0.4s ease forwards";
              setTimeout(() => {
                if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
                }
              }, 400);
            }
          }, duration);
        } catch (error) {
          console.error("‚ùå Error showing notification:", error);
          alert(`${type.toUpperCase()}: ${message}`);
        }
      }

      function showLoading(message = "ƒêang t·∫£i...") {
        try {
          const overlay = document.getElementById("loadingOverlay");
          const text = overlay?.querySelector(".loading-text");
          if (text) text.textContent = message;
          if (overlay) overlay.classList.add("show");
        } catch (error) {
          console.error("‚ùå Error showing loading overlay:", error);
        }
      }

      function hideLoading() {
        try {
          const overlay = document.getElementById("loadingOverlay");
          if (overlay) overlay.classList.remove("show");
        } catch (error) {
          console.error("‚ùå Error hiding loading overlay:", error);
        }
      }

      // ===================== CHART FUNCTIONALITY =====================
      function createChart(canvasId, data, color = "#e74c3c", label = "") {
        const ctx = document.getElementById(canvasId)?.getContext("2d");
        if (!ctx) return null;

        // Destroy existing chart if exists
        if (dashboardCharts[canvasId]) {
          dashboardCharts[canvasId].destroy();
        }

        dashboardCharts[canvasId] = new Chart(ctx, {
          type: "line",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: `${color}20`,
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: color,
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                enabled: true,
                mode: "index",
                intersect: false,
                backgroundColor: "rgba(0,0,0,0.8)",
                titleColor: "#fff",
                bodyColor: "#fff",
                borderColor: color,
                borderWidth: 1,
              },
            },
            scales: {
              x: {
                display: true,
                grid: {
                  display: true,
                  color: "rgba(0,0,0,0.1)",
                },
                ticks: {
                  color: "#666",
                  font: { size: 11 },
                },
              },
              y: {
                display: true,
                grid: {
                  display: true,
                  color: "rgba(0,0,0,0.1)",
                },
                ticks: {
                  color: "#666",
                  font: { size: 11 },
                  callback: function (value) {
                    if (canvasId === "chart2") {
                      return value + "k";
                    }
                    return value;
                  },
                },
              },
            },
            elements: {
              line: { borderWidth: 2 },
              point: { radius: 0, hoverRadius: 6 },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
          },
        });

        return dashboardCharts[canvasId];
      }

      function updateCharts(chartsData) {
        const data = chartsData || enhancedChartData;

        createChart("chart1", data.products, "#e74c3c", "S·∫£n ph·∫©m");
        createChart("chart2", data.revenue, "#e74c3c", "Doanh thu");
        createChart("chart3", data.users, "#e74c3c", "Ng∆∞·ªùi d√πng");
      }

      // ===================== PROFILE MODAL FUNCTIONS =====================
      function viewProfile() {
        const dropdownMenu = document.getElementById("dropdownMenu");
        dropdownMenu.classList.remove("show");

        console.log("üë§ Opening profile modal for user:", currentUser);

        if (currentUser) {
          updateUserInfo(currentUser);
        } else {
          loadCurrentUserInfo();
        }

        document.getElementById("profileModal").classList.add("show");
      }

      async function loadCurrentUserInfo() {
        try {
          const response = await fetch("/api/auth/me", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.user) {
              currentUser = result.user;
              updateUserInfo(result.user);
            }
          }
        } catch (error) {
          console.error("‚ùå Failed to load user info:", error);
        }
      }

      function closeProfileModal() {
        document.getElementById("profileModal").classList.remove("show");
        // Clear password fields
        const oldPassword = document.getElementById("oldPassword");
        const newPassword = document.getElementById("newPassword");
        const confirmPassword = document.getElementById("confirmPassword");

        if (oldPassword) oldPassword.value = "";
        if (newPassword) newPassword.value = "";
        if (confirmPassword) confirmPassword.value = "";
      }

      async function saveProfile() {
        const oldPassword = document.getElementById("oldPassword").value.trim();
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document
          .getElementById("confirmPassword")
          .value.trim();
        const fullName = document.getElementById("fullName").value.trim();

        // Check if there are any changes
        const hasPasswordChanges =
          oldPassword || newPassword || confirmPassword;
        const hasNameChanges = fullName !== (currentUser?.fullName || "");

        if (!hasPasswordChanges && !hasNameChanges) {
          showNotification("Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ l∆∞u", "info");
          return;
        }

        // Validate password change if any password field is filled
        if (hasPasswordChanges) {
          if (!oldPassword) {
            showNotification("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i", "error");
            return;
          }
          if (!newPassword) {
            showNotification("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi", "error");
            return;
          }
          if (newPassword !== confirmPassword) {
            showNotification("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp", "error");
            return;
          }
          if (newPassword.length < 6) {
            showNotification("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", "error");
            return;
          }
        }

        try {
          showLoading("ƒêang c·∫≠p nh·∫≠t...");

          const updateData = {};
          if (hasPasswordChanges) {
            updateData.oldPassword = oldPassword;
            updateData.newPassword = newPassword;
          }
          if (hasNameChanges) {
            updateData.fullName = fullName;
          }

          const response = await fetch("/api/auth/update-profile", {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showNotification("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!", "success");
            if (result.user) {
              currentUser = result.user;
              updateUserInfo(result.user);
            }
            closeProfileModal();
          } else {
            showNotification(result.error || "C·∫≠p nh·∫≠t th·∫•t b·∫°i", "error");
          }
        } catch (error) {
          console.error("Profile update error:", error);
          showNotification("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!", "error");
        } finally {
          hideLoading();
        }
      }

      // ===================== APPLICATION STARTUP =====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîß DOM loaded, initializing dashboard...");

        try {
          // Check auth first
          if (!authToken) {
            console.log("‚ùå No auth token, redirecting to login");
            window.location.href = "/login";
            return;
          }

          // Initialize app safely
          initApp().catch((error) => {
            console.error("‚ùå App initialization failed:", error);
            handleInitError(error);
          });
        } catch (error) {
          console.error("‚ùå Critical error during initialization:", error);
          handleInitError(error);
        }
      });

      // Show/hide password functionality
      const showPasswordCheckbox = document.getElementById("showPassword");
      if (showPasswordCheckbox) {
        showPasswordCheckbox.addEventListener("change", (e) => {
          const passwordInputs = [
            document.getElementById("oldPassword"),
            document.getElementById("newPassword"),
            document.getElementById("confirmPassword"),
          ];

          passwordInputs.forEach((input) => {
            if (input) {
              input.type = e.target.checked ? "text" : "password";
            }
          });
        });
      }

      // Navigation handling
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();

          // Update active state
          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");

          // Handle navigation
          const page = item.getAttribute("data-page");
          if (page && page !== "dashboard") {
            window.location.href = item.href;
          }
        });
      });

      // ===================== SECURITY & LIFECYCLE MANAGEMENT =====================

      // Handle page visibility changes for better security
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && authToken) {
          // Re-verify auth when page becomes visible
          checkAuth();
        }
      });

      // Auto-logout on token expiration (check every 5 minutes)
      setInterval(() => {
        if (authToken && !document.hidden) {
          checkAuth();
        }
      }, 5 * 60 * 1000);

      // Handle browser back/forward navigation
      window.addEventListener("popstate", (e) => {
        if (!authToken) {
          window.location.href = "/login";
        }
      });

      // Prevent back button after logout
      window.addEventListener("pageshow", (e) => {
        if (e.persisted && !authToken) {
          window.location.href = "/login";
        }
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // ESC to close modals
        if (e.key === "Escape") {
          closeProfileModal();
          const dropdownMenu = document.getElementById("dropdownMenu");
          if (dropdownMenu) {
            dropdownMenu.classList.remove("show");
          }
        }
      });

      // Auto-refresh data every 5 minutes
      setInterval(() => {
        if (authToken && !document.hidden) {
          loadDashboardData();
        }
      }, 5 * 60 * 1000);

      console.log("‚úÖ Enhanced Sales Management Dashboard loaded");
      console.log("‚úÖ Enhanced authentication and logout system activated");
    </script>
  </body>
</html>
