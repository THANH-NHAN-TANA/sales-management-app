<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê∆°n h√†ng - Sales Management System</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f7fa;
        color: #333;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 10px;
        font-size: 22px;
      }

      .nav-menu {
        display: flex;
        gap: 25px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        color: white;
        font-weight: 500;
        position: relative;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 600;
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #f0f0f0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #667eea;
        font-size: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .settings-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 120%;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 220px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-15px);
        transition: all 0.4s ease;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .dropdown-item:hover {
        background: #f8f9fa;
      }

      .dropdown-item:first-child {
        border-bottom: 1px solid #eee;
      }

      .dropdown-item:first-child:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .dropdown-item:last-child:hover {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      .dropdown-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }

      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
        min-height: calc(100vh - 80px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
      }

      .page-subtitle {
        color: #7f8c8d;
        font-size: 16px;
        margin-top: 5px;
      }

      .add-order-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .add-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .orders-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .section-header {
        padding: 25px 30px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .search-filters {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .search-input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        width: 250px;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .filter-select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-select:focus {
        outline: none;
        border-color: #667eea;
      }

      .orders-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 25px;
      }

      .order-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border: 1px solid #e8ecef;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .order-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .order-header {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding-right: 15px;
        border-right: 2px solid #e0e0e0;
      }

      .order-id {
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
      }

      .order-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }

      .order-status.pending,
      .order-status.processing {
        background: #fff3cd;
        color: #856404;
      }

      .order-status.shipped,
      .order-status.delivered {
        background: #cce5ff;
        color: #004085;
      }

      .order-status.completed {
        background: #d4edda;
        color: #155724;
      }

      .order-status.cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .order-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .order-total {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
      }

      .order-customer {
        font-size: 14px;
        color: #7f8c8d;
      }

      .order-date {
        font-size: 14px;
        color: #2c3e50;
      }

      .order-actions {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-view {
        background: #17a2b8;
        color: white;
      }

      .btn-view:hover {
        background: #138496;
      }

      .btn-cancel {
        background: #dc3545;
        color: white;
      }

      .btn-cancel:hover {
        background: #c82333;
      }

      .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: #7f8c8d;
      }

      .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #bdc3c7;
      }

      .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #95a5a6;
      }

      .empty-state p {
        font-size: 16px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #667eea;
        font-weight: 600;
        font-size: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .notification {
        position: fixed;
        top: 25px;
        right: 25px;
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        z-index: 3000;
        animation: slideInRight 0.4s ease;
        max-width: 350px;
        font-weight: 500;
      }

      .notification.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .notification.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .notification.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .notification.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s ease;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 35px;
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.4s ease;
        position: relative;
      }

      .modal-overlay.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
      }

      .modal-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-modal:hover {
        background: #f0f0f0;
        color: #666;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: #f9f9f9;
        color: #333;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-input[readonly] {
        background: #f8f9fa;
        cursor: not-allowed;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 25px;
        border-top: 1px solid #eee;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #e9e9e9;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
      }

      .profile-modal .modal-content,
      .add-order-modal .modal-content {
        max-width: 600px;
      }

      .profile-section {
        margin-bottom: 25px;
      }

      .profile-section .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .password-section {
        border-top: 1px solid #eee;
        padding-top: 25px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #666;
      }

      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      .item-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 0;
      }

      .item-row input[type="number"] {
        width: 60px;
        padding: 5px;
      }

      @media (max-width: 768px) {
        .nav-menu {
          display: none;
        }

        .main-content {
          padding: 20px 15px;
        }

        .page-header {
          flex-direction: column;
          gap: 20px;
          align-items: flex-start;
        }

        .search-filters {
          flex-direction: column;
          width: 100%;
        }

        .search-input,
        .filter-select {
          width: 100%;
          font-size: 13px;
          padding: 10px;
        }

        .orders-grid {
          padding: 20px;
        }

        .order-card {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .order-header {
          flex-direction: row;
          justify-content: space-between;
          width: 100%;
          border-right: none;
          border-bottom: 2px solid #e0e0e0;
          padding: 10px 0;
        }

        .order-id {
          font-size: 14px;
        }

        .order-status {
          padding: 5px 10px;
          font-size: 11px;
        }

        .order-details {
          padding: 0;
        }

        .order-actions {
          width: 100%;
          gap: 8px;
        }

        .btn-paid {
          background: #28a745;
          color: white;
        }

        .btn-paid:hover {
          background: #218838;
        }

        .btn-unpaid {
          background: #ffc107;
          color: white;
        }

        .btn-unpaid:hover {
          background: #e0a800;
        }

        .action-btn {
          flex: 1;
          font-size: 12px;
          padding: 8px;
        }

        .modal-content {
          width: 95%;
          padding: 20px;
          max-height: 90vh;
        }

        .modal-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .modal-title {
          font-size: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .modal-buttons {
          flex-direction: column;
          gap: 10px;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }

        .item-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .item-row input[type="number"] {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <header class="header">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>MeTroMini Store</span>
      </div>

      <nav class="nav-menu">
        <a
          href="/dashboard"
          class="nav-item nav-dashboard"
          data-page="dashboard"
        >
          <i class="fas fa-home"></i>
          T·ªïng quan
        </a>
        <a
          href="/products-page"
          class="nav-item nav-products"
          data-page="products"
        >
          <i class="fas fa-box"></i>
          S·∫£n ph·∫©m
        </a>
        <a
          href="/customers-page"
          class="nav-item nav-customers"
          data-page="customers"
        >
          <i class="fas fa-users"></i>
          Kh√°ch h√†ng
        </a>
        <a
          href="/orders-page"
          class="nav-item nav-orders active"
          data-page="orders"
        >
          <i class="fas fa-shopping-cart"></i>
          ƒê∆°n h√†ng
        </a>
        <a
          href="/statistics-page"
          class="nav-item nav-statistics"
          data-page="statistics"
        >
          <i class="fas fa-chart-bar"></i>
          Th·ªëng k√™
        </a>
      </nav>

      <div class="user-info">
        <span class="user-name" id="userName">ƒêang t·∫£i...</span>
        <div class="user-avatar" id="userAvatar" title="Th√¥ng tin c√° nh√¢n">
          ?
        </div>
        <button class="settings-btn" id="settingsBtn" title="C√†i ƒë·∫∑t">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <button class="dropdown-item" id="profileBtn">
            <i class="fas fa-user dropdown-icon"></i> Th√¥ng tin c√° nh√¢n
          </button>
          <button class="dropdown-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt dropdown-icon"></i> ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
          <p class="page-subtitle">Qu·∫£n l√Ω danh s√°ch ƒë∆°n h√†ng trong h·ªá th·ªëng</p>
        </div>
        <button class="add-order-btn" id="addOrderBtn">
          <i class="fas fa-plus"></i> Th√™m ƒë∆°n h√†ng
        </button>
      </div>

      <div class="orders-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-shopping-cart"></i> Danh s√°ch ƒë∆°n h√†ng
          </h2>
          <div class="search-filters">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="T√¨m ki·∫øm theo m√£ ƒë∆°n h√†ng ho·∫∑c kh√°ch h√†ng..."
              autocomplete="off"
              name="search_random"
            />
            <select class="filter-select" id="statusFilter">
              <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
              <option value="processing">ƒêang x·ª≠ l√Ω</option>
              <option value="shipped">ƒêang giao</option>
              <option value="delivered">ƒê√£ giao</option>
              <option value="completed">Ho√†n th√†nh</option>
              <option value="cancelled">ƒê√£ h·ªßy</option>
            </select>
          </div>
        </div>

        <div class="orders-grid" id="ordersGrid">
          <!-- Orders will be loaded here -->
        </div>
      </div>
    </main>

    <!-- Profile Modal -->
    <div class="modal-overlay profile-modal" id="profileModal">
      <div class="modal-content">
        <button class="close-modal" id="closeProfileModalBtn" title="ƒê√≥ng">
          √ó
        </button>
        <div class="modal-header">
          <div class="modal-icon"><i class="fas fa-user"></i></div>
          <h2 class="modal-title">Th√¥ng tin c√° nh√¢n</h2>
        </div>
        <div class="profile-section">
          <div class="section-title">
            <i class="fas fa-id-card"></i> Th√¥ng tin t√†i kho·∫£n
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input
                type="text"
                class="form-input"
                id="profileUsername"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label">Vai tr√≤</label>
              <input
                type="text"
                class="form-input"
                id="profileUserRole"
                readonly
              />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="profileEmail" readonly />
          </div>
          <div class="form-group">
            <label class="form-label">H·ªç v√† t√™n</label>
            <input type="text" class="form-input" id="profileFullName" />
          </div>
        </div>
        <div class="profile-section password-section">
          <div class="section-title">
            <i class="fas fa-lock"></i> ƒê·ªïi m·∫≠t kh·∫©u
          </div>
          <div class="form-group">
            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input
              type="password"
              class="form-input"
              id="profileOldPassword"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                class="form-input"
                id="profileNewPassword"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
              />
            </div>
            <div class="form-group">
              <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
              <input
                type="password"
                class="form-input"
                id="profileConfirmPassword"
                placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
              />
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="profileShowPassword" />
            <label for="profileShowPassword">Hi·ªÉn th·ªã m·∫≠t kh·∫©u</label>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-secondary" id="profileCancelBtn">
            <i class="fas fa-times"></i> H·ªßy
          </button>
          <button class="btn btn-primary" id="profileSaveBtn">
            <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
          </button>
        </div>
      </div>
    </div>

    <!-- Add Order Modal -->
    <div class="modal-overlay add-order-modal" id="addOrderModal">
      <div class="modal-content">
        <button class="close-modal" id="closeAddOrderModal" title="ƒê√≥ng">
          √ó
        </button>
        <div class="modal-header">
          <div class="modal-icon"><i class="fas fa-plus"></i></div>
          <h2 class="modal-title">Th√™m ƒë∆°n h√†ng</h2>
        </div>
        <div class="form-group">
          <label class="form-label">Kh√°ch h√†ng</label>
          <select class="form-input" id="addOrderCustomer">
            <option value="">Ch·ªçn kh√°ch h√†ng</option>
            <!-- ƒê∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
          <select class="form-input" id="addOrderPayMethod">
            <option value="cash">Ti·ªÅn m·∫∑t</option>
            <option value="card">Th·∫ª t√≠n d·ª•ng</option>
            <option value="bank_transfer">Chuy·ªÉn kho·∫£n</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Danh s√°ch s·∫£n ph·∫©m</label>
          <div
            id="addOrderItemsList"
            style="
              max-height: 200px;
              overflow-y: auto;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 10px;
            "
          >
            <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </div>
          <button
            class="btn btn-primary"
            id="addOrderItemBtn"
            style="margin-top: 10px"
          >
            <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Gi·∫£m gi√° (VND)</label>
          <input
            type="number"
            class="form-input"
            id="addOrderDiscount"
            value="0"
            min="0"
          />
        </div>
        <div class="modal-buttons">
          <button class="btn btn-secondary" id="cancelAddOrderBtn">
            <i class="fas fa-times"></i> H·ªßy
          </button>
          <button class="btn btn-primary" id="saveAddOrderBtn">
            <i class="fas fa-save"></i> L∆∞u
          </button>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal-overlay" id="orderModal">
      <div class="modal-content">
        <button class="close-modal" id="closeOrderModal" title="ƒê√≥ng">√ó</button>
        <div class="modal-header">
          <div class="modal-icon"><i class="fas fa-shopping-cart"></i></div>
          <h2 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng</h2>
        </div>
        <div class="form-group">
          <label class="form-label">M√£ ƒë∆°n h√†ng</label>
          <input type="text" class="form-input" id="orderId" readonly />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">T·ªïng ti·ªÅn</label>
            <input
              type="text"
              class="form-input"
              id="orderTotalPrice"
              readonly
            />
          </div>
          <div class="form-group">
            <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <input
              type="text"
              class="form-input"
              id="orderPayMethod"
              readonly
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ng√†y t·∫°o</label>
            <input
              type="text"
              class="form-input"
              id="orderCreatedDate"
              readonly
            />
          </div>
          <div class="form-group">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <input type="text" class="form-input" id="orderStatus" readonly />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">M√£ gi·∫£m gi√°</label>
          <input
            type="text"
            class="form-input"
            id="orderVoucherCode"
            readonly
          />
        </div>
        <div class="form-group">
          <label class="form-label">Gi·∫£m gi√°</label>
          <input type="text" class="form-input" id="orderDiscount" readonly />
        </div>
        <div class="form-group">
          <label class="form-label">Kh√°ch h√†ng</label>
          <input
            type="text"
            class="form-input"
            id="orderCustomerName"
            readonly
          />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email kh√°ch h√†ng</label>
            <input
              type="email"
              class="form-input"
              id="orderCustomerEmail"
              readonly
            />
          </div>
          <div class="form-group">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng</label>
            <input
              type="text"
              class="form-input"
              id="orderCustomerPhone"
              readonly
            />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Danh s√°ch s·∫£n ph·∫©m</label>
          <div
            id="orderItemsList"
            style="
              max-height: 200px;
              overflow-y: auto;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 10px;
            "
          >
            <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn btn-secondary" id="closeOrderBtn">
            <i class="fas fa-times"></i> ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <!-- Cancel Order Confirmation Modal -->
    <div class="modal-overlay delete-modal" id="cancelModal">
      <div class="modal-content">
        <button class="close-modal" id="closeCancelModal" title="ƒê√≥ng">
          √ó
        </button>
        <div class="modal-icon" style="background: #dc3545">
          <i class="fas fa-ban"></i>
        </div>
        <h2 class="modal-title">X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng</h2>
        <p class="delete-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng:</p>
        <div class="delete-customer-name" id="cancelOrderId"></div>
        <p class="delete-message" style="color: #dc3545; font-weight: 600">
          H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!
        </p>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" id="cancelCancelBtn">
            <i class="fas fa-times"></i> H·ªßy
          </button>
          <button type="button" class="btn btn-danger" id="confirmCancelBtn">
            <i class="fas fa-ban"></i> H·ªßy ƒë∆°n h√†ng
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("üöÄ Orders Page Loading...");

      // ===================== GLOBAL VARIABLES =====================
      let currentUser = null;
      let authToken =
        localStorage.getItem("authToken") ||
        sessionStorage.getItem("authToken");
      let orders = [];
      let filteredOrders = [];
      let orderToCancel = null;
      const cache = new Map(); // Cache cho danh s√°ch ƒë∆°n h√†ng
      const CACHE_TTL = 5 * 60 * 1000; // 5 ph√∫t

      // ===================== AUTHENTICATION =====================
      async function checkAuth() {
        const authToken =
          localStorage.getItem("authToken") ||
          sessionStorage.getItem("authToken");
        if (!authToken || !authToken.includes(".")) {
          console.log("‚ùå Invalid or no auth token found");
          redirectToLogin();
          return false;
        }
        try {
          showLoading("ƒêang x√°c th·ª±c...");
          const response = await fetch("/api/auth/verify", {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          if (!response.ok)
            throw new Error(
              `HTTP ${response.status}: ${await response.text()}`
            );
          const result = await response.json();
          if (result.success) {
            currentUser = result.user;
            updateUserInfo(currentUser);
            return true;
          }
          throw new Error("Invalid response");
        } catch (error) {
          console.error("‚ùå Auth verification failed:", error.message);
          localStorage.removeItem("authToken");
          sessionStorage.removeItem("authToken");
          showNotification("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n", "error");
          setTimeout(redirectToLogin, 1500);
          return false;
        } finally {
          hideLoading();
        }
      }

      function redirectToLogin() {
        console.log("üîÑ Redirecting to login page");
        showNotification("ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...", "info");
        setTimeout(() => (window.location.href = "/login"), 1000);
      }

      function updateUserInfo(user) {
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");
        let displayName =
          user.full_name || user.name || user.username || "User";
        if (user.role === "admin" && !displayName) {
          displayName = "Admin";
        }

        console.log("üë§ Updating user info:", {
          displayName,
          role: user.role,
          username: user.username,
        });
        if (userName) userName.textContent = displayName;
        if (userAvatar) {
          userAvatar.textContent = displayName.charAt(0).toUpperCase();
          userAvatar.title = `${
            user.role === "admin" ? "Admin" : "User"
          }: ${displayName}`;
        }

        const profileUsername = document.getElementById("profileUsername");
        const profileUserRole = document.getElementById("profileUserRole");
        const profileEmail = document.getElementById("profileEmail");
        const profileFullName = document.getElementById("profileFullName");

        if (profileUsername) profileUsername.value = user.username || "";
        if (profileUserRole)
          profileUserRole.value = user.role === "admin" ? "Admin" : "User";
        if (profileEmail) profileEmail.value = user.email || "";
        if (profileFullName)
          profileFullName.value = user.full_name || user.name || "";
      }

      function redirectToLogin() {
        console.log("üîÑ Redirecting to login page");
        showNotification("ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...", "info");
        setTimeout(() => (window.location.href = "/login"), 1000);
      }

      function updateUserInfo(user) {
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");
        let displayName =
          user.full_name || user.name || user.username || "User";
        if (user.role === "admin" && !displayName) {
          displayName = "Admin";
        }

        console.log("üë§ Updating user info:", {
          displayName,
          role: user.role,
          username: user.username,
        });
        if (userName) userName.textContent = displayName;
        if (userAvatar) {
          userAvatar.textContent = displayName.charAt(0).toUpperCase();
          userAvatar.title = `${
            user.role === "admin" ? "Admin" : "User"
          }: ${displayName}`;
        }

        const profileUsername = document.getElementById("profileUsername");
        const profileUserRole = document.getElementById("profileUserRole");
        const profileEmail = document.getElementById("profileEmail");
        const profileFullName = document.getElementById("profileFullName");

        if (profileUsername) profileUsername.value = user.username || "";
        if (profileUserRole)
          profileUserRole.value = user.role === "admin" ? "Admin" : "User";
        if (profileEmail) profileEmail.value = user.email || "";
        if (profileFullName)
          profileFullName.value = user.full_name || user.name || "";
      }

      // ===================== ORDERS DATA =====================
      async function loadOrders(search = "", status = "") {
        const cacheKey = `orders_${search}_${status}`;
        const cached = cache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
          console.log("üì¶ Using cached orders");
          orders = cached.data;
          filteredOrders = [...orders];
          displayOrders(filteredOrders);
          return;
        }

        if (!authToken || !authToken.includes(".")) {
          console.warn("‚ö†Ô∏è Invalid auth token");
          redirectToLogin();
          return;
        }

        try {
          showLoading("ƒêang t·∫£i ƒë∆°n h√†ng...");
          console.log("üìã Loading orders with params:", { search, status });
          const response = await fetch(
            `/api/orders?search=${encodeURIComponent(
              search
            )}&status=${encodeURIComponent(status)}`,
            {
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
            }
          );
          const result = await response.json();
          console.log("üìã Orders response:", result);
          if (!response.ok) {
            if (response.status === 401) {
              console.error("‚ùå Unauthorized: Invalid or expired token");
              localStorage.removeItem("authToken");
              sessionStorage.removeItem("authToken");
              showNotification("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n", "error");
              redirectToLogin();
              return;
            }
            throw new Error(
              result.error || `HTTP ${response.status}: L·ªói kh√¥ng x√°c ƒë·ªãnh`
            );
          }
          if (result.success && Array.isArray(result.orders)) {
            orders = result.orders.map((order) => ({
              ...order,
              user: order.user || {
                full_name: "Kh√°ch kh√¥ng x√°c ƒë·ªãnh",
                email: "N/A",
                phone: "N/A",
              },
              status: order.status || "pending",
              payment_status: order.payment_status || "unpaid", // Th√™m payment_status
              created_date: order.created_date || new Date().toISOString(),
              total_price: order.total_price || 0,
            }));
            cache.set(cacheKey, { data: orders, timestamp: Date.now() });
            filteredOrders = [...orders];
            displayOrders(filteredOrders);
            console.log(`‚úÖ Loaded ${orders.length} orders`);
          } else {
            throw new Error(result.error || "D·ªØ li·ªáu ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá");
          }
        } catch (error) {
          console.error("‚ùå Load orders error:", error);
          orders = [];
          filteredOrders = [];
          showNotification(
            `Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng: ${error.message}`,
            "error"
          );
          displayEmptyState();
        } finally {
          hideLoading();
        }
      }

      async function loadCustomersForAddOrder() {
        try {
          const response = await fetch("/api/customers", {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const result = await response.json();
          if (response.ok && result.success) {
            const customerSelect = document.getElementById("addOrderCustomer");
            customerSelect.innerHTML =
              '<option value="">Ch·ªçn kh√°ch h√†ng</option>';
            result.customers.forEach((customer) => {
              customerSelect.innerHTML += `<option value="${customer.id}">${customer.full_name} (${customer.email})</option>`;
            });
          }
        } catch (error) {
          console.error("‚ùå Load customers error:", error);
          showNotification("Kh√¥ng th·ªÉ t·∫£i danh s√°ch kh√°ch h√†ng", "error");
        }
      }

      let products = []; // Th√™m bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u s·∫£n ph·∫©m

      async function loadProductsForAddOrder() {
        try {
          const response = await fetch("/api/products", {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const result = await response.json();
          if (response.ok && result.success) {
            products = result.products; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
            const itemsList = document.getElementById("addOrderItemsList");
            itemsList.innerHTML = result.products
              .map(
                (product) => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 5px;">
              <input type="checkbox" data-product-id="${product.id}" />
              <span>${product.name} - ${formatCurrency(product.price)}</span>
              <input type="number" min="1" data-quantity value="1" style="width: 60px; padding: 5px;" />
            </div>
          `
              )
              .join("");
          }
        } catch (error) {
          console.error("‚ùå Load products error:", error);
          showNotification("Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m", "error");
        }
      }

      document
        .getElementById("saveAddOrderBtn")
        .addEventListener("click", async () => {
          const user_id = document.getElementById("addOrderCustomer").value;
          const pay_method = document.getElementById("addOrderPayMethod").value;
          const discount_applied =
            parseFloat(document.getElementById("addOrderDiscount").value) || 0;
          const items = Array.from(
            document.querySelectorAll(
              "#addOrderItemsList input[type='checkbox']:checked"
            )
          ).map((checkbox) => {
            const productId = checkbox.getAttribute("data-product-id");
            const quantity = parseInt(
              checkbox.parentElement.querySelector("[data-quantity]").value
            );
            const product = products.find((p) => p.id === productId);
            return {
              product_id: productId,
              quantity,
              price_at_purchase: product ? product.price : 0,
            };
          });
          const total_price =
            items.reduce(
              (sum, item) => sum + item.quantity * item.price_at_purchase,
              0
            ) - discount_applied;

          if (!user_id || !pay_method || !items.length) {
            showNotification("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin", "warning");
            return;
          }

          try {
            showLoading("ƒêang t·∫°o ƒë∆°n h√†ng...");
            const response = await fetch("/api/orders", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user_id,
                total_price,
                pay_method,
                items,
                discount_applied,
              }),
            });
            const result = await response.json();
            if (response.ok && result.success) {
              showNotification("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng", "success");
              document.getElementById("addOrderModal").classList.remove("show");
              cache.clear();
              await loadOrders();
              filteredOrders = [...orders];
              displayOrders(filteredOrders);
            } else {
              throw new Error(result.error || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
            }
          } catch (error) {
            console.error("‚ùå Create order error:", error);
            showNotification(
              `Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng: ${error.message}`,
              "error"
            );
          } finally {
            hideLoading();
          }
        });

      async function addOrder() {
        document.getElementById("addOrderModal").classList.add("show");
        await loadCustomersForAddOrder();
      }

      document
        .getElementById("addOrderBtn")
        .addEventListener("click", addOrder);
      document
        .getElementById("closeAddOrderModal")
        .addEventListener("click", () => {
          document.getElementById("addOrderModal").classList.remove("show");
        });
      document
        .getElementById("cancelAddOrderBtn")
        .addEventListener("click", () => {
          document.getElementById("addOrderModal").classList.remove("show");
        });
      document
        .getElementById("saveAddOrderBtn")
        .addEventListener("click", async () => {
          const user_id = document.getElementById("addOrderCustomer").value;
          const pay_method = document.getElementById("addOrderPayMethod").value;
          const discount_applied =
            parseFloat(document.getElementById("addOrderDiscount").value) || 0;
          const items = []; // C·∫ßn th√™m logic ƒë·ªÉ l·∫•y danh s√°ch s·∫£n ph·∫©m
          const total_price = items.reduce(
            (sum, item) => sum + item.quantity * item.price_at_purchase,
            0
          );

          if (!user_id || !pay_method || !items.length) {
            showNotification("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin", "warning");
            return;
          }

          try {
            showLoading("ƒêang t·∫°o ƒë∆°n h√†ng...");
            const response = await fetch("/api/orders", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user_id,
                total_price,
                pay_method,
                items,
                discount_applied,
              }),
            });
            const result = await response.json();
            if (response.ok && result.success) {
              showNotification("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng", "success");
              document.getElementById("addOrderModal").classList.remove("show");
              cache.clear();
              await loadOrders();
              filteredOrders = [...orders];
              displayOrders(filteredOrders);
            } else {
              throw new Error(result.error || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
            }
          } catch (error) {
            console.error("‚ùå Create order error:", error);
            showNotification(
              `Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng: ${error.message}`,
              "error"
            );
          } finally {
            hideLoading();
          }
        });

      function displayOrders(ordersToShow) {
        const ordersGrid = document.getElementById("ordersGrid");
        if (!ordersGrid) {
          console.error("‚ùå OrdersGrid element not found");
          showNotification(
            "L·ªói giao di·ªán: Kh√¥ng t√¨m th·∫•y l∆∞·ªõi ƒë∆°n h√†ng",
            "error"
          );
          return;
        }

        if (
          !ordersToShow ||
          !Array.isArray(ordersToShow) ||
          ordersToShow.length === 0
        ) {
          console.warn("‚ö†Ô∏è No orders to display");
          displayEmptyState();
          return;
        }

        ordersGrid.innerHTML = ordersToShow
          .filter((order) => order && order.id && order.user)
          .map((order) => createOrderCard(order))
          .join("");

        if (ordersGrid.innerHTML.trim() === "") {
          displayEmptyState();
        }

        console.log(`‚úÖ Displayed ${ordersToShow.length} orders`);
      }
      function createOrderCard(order) {
        if (!order.id) {
          console.error("‚ùå Order missing ID:", order);
          return "";
        }

        const totalPrice = formatCurrency(order.total_price || 0);
        const customerName = order.user?.full_name || "N/A";
        const statusText = translateStatus(order.status);
        const statusClass = order.status.toLowerCase();
        const paymentStatus = order.payment_status || "unpaid"; // L·∫•y tr·∫°ng th√°i thanh to√°n
        const isDisabled =
          order.status === "cancelled" || order.status === "completed";

        return `
    <div class="order-card" data-id="${order.id}">
      <div class="order-header">
        <span class="order-id">ƒê∆°n h√†ng #${order.id
          .toString()
          .padStart(8, "0")}</span>
        <span class="order-status ${statusClass}">${statusText}</span>
      </div>
      <div class="order-details">
        <p class="order-total">${totalPrice}</p>
        <p class="order-customer">${customerName}</p>
        <p class="order-date">${new Date(order.created_date).toLocaleString(
          "vi-VN"
        )}</p>
        <div class="order-actions">
          <button class="action-btn btn-view" data-order-id="${
            order.id
          }" data-action="view">
            <i class="fas fa-eye"></i> Xem chi ti·∫øt
          </button>
          <button class="action-btn btn-cancel" data-order-id="${
            order.id
          }" data-action="cancel" ${isDisabled ? "disabled" : ""}>
            <i class="fas fa-ban"></i> H·ªßy
          </button>
          <button class="action-btn btn-paid" data-order-id="${
            order.id
          }" data-action="paid" ${
          isDisabled || paymentStatus === "paid" ? "disabled" : ""
        }>
            <i class="fas fa-check-circle"></i> ƒê√£ thanh to√°n
          </button>
          <button class="action-btn btn-unpaid" data-order-id="${
            order.id
          }" data-action="unpaid" ${
          isDisabled || paymentStatus === "unpaid" ? "disabled" : ""
        }>
            <i class="fas fa-times-circle"></i> Ch∆∞a thanh to√°n
          </button>
        </div>
      </div>
    </div>
  `;
      }

      function displayEmptyState() {
        const ordersGrid = document.getElementById("ordersGrid");
        const searchTerm =
          document.getElementById("searchInput")?.value.trim() || "";
        let message = "Ch∆∞a c√≥ ƒë∆°n h√†ng trong danh s√°ch.";
        if (searchTerm) {
          message = `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o kh·ªõp v·ªõi "${searchTerm}".`;
        }

        ordersGrid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-shopping-cart"></i>
            <h3>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</h3>
            <p>${message}</p>
        </div>
    `;
      }

      // ===================== SEARCH AND FILTER =====================
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function setupFilters() {
        const searchInput = document.getElementById("searchInput");
        const statusFilter = document.getElementById("statusFilter");

        if (!searchInput || !statusFilter) {
          console.warn("‚ö†Ô∏è Search input or status filter not found");
          return;
        }

        searchInput.setAttribute("autocomplete", "off");
        searchInput.value = "";
        statusFilter.value = "";
        console.log("‚úÖ Cleared search input and status filter");

        searchInput.addEventListener("focus", () => {
          if (searchInput.value.includes("@")) {
            console.warn(
              "‚ö†Ô∏è Detected email in searchInput:",
              searchInput.value
            );
            searchInput.value = "";
          }
        });

        searchInput.addEventListener("input", () => {
          if (searchInput.value.includes("@")) {
            console.warn(
              "‚ö†Ô∏è Detected invalid input in searchInput:",
              searchInput.value
            );
            searchInput.value = "";
            showNotification(
              "Vui l√≤ng kh√¥ng nh·∫≠p email v√†o √¥ t√¨m ki·∫øm",
              "warning"
            );
          }
        });

        const debouncedApplyFilters = debounce(applyFilters, 500);
        searchInput.addEventListener("input", debouncedApplyFilters);
        statusFilter.addEventListener("change", debouncedApplyFilters);
        console.log("‚úÖ Filters setup completed");
      }

      function applyFilters() {
        const searchInput = document.getElementById("searchInput");
        const statusFilter = document.getElementById("statusFilter");

        if (!searchInput || !statusFilter || !orders || !orders.length === 0) {
          console.warn("‚ö†Ô∏è Invalid filters or empty orders list");
          showNotification("Kh√¥ng c√≥ ƒë∆°n h√†ng ƒë·ªÉ l·ªçc", "warning");
          displayOrders(orders || []);
          return;
        }

        const searchTerm = searchInput.value.toLowerCase().trim();
        const status = statusFilter.value.toLowerCase();

        console.log("üîç Applying filters:", { searchTerm, status });

        filteredOrders = orders.filter((order) => {
          if (!order || !order.id) {
            console.warn("‚ö†Ô∏è Invalid order:", order);
            return false;
          }

          const matchesSearch =
            order.id.toString().includes(searchTerm) ||
            (order.user?.full_name &&
              order.user.full_name.toLowerCase().includes(searchTerm)) ||
            (order.user?.email &&
              order.user.email.toLowerCase().includes(searchTerm));
          const matchesStatus =
            !status || order.status.toLowerCase() === status;

          return matchesSearch && matchesStatus;
        });

        console.log(`üîç Filtered ${filteredOrders.length} orders`);
        if (filteredOrders.length === 0 && (searchTerm || status)) {
          showNotification(
            `Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o kh·ªõp v·ªõi b·ªô l·ªçc`,
            "info"
          );
        }

        displayOrders(filteredOrders);
      }

      // ==================== ORDER ACTIONS ==================
      async function viewOrder(id) {
        try {
          showLoading("ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng...");
          const response = await fetch(`/api/orders/${id}/details`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });
          const result = await response.json();
          if (!response.ok || !result.success || !result.order) {
            throw new Error(result.error || "Failed to fetch order details");
          }

          const order = result.order;
          document.getElementById("orderId").value = `#${order.id
            .toString()
            .padStart(8, "0")}`;
          document.getElementById("orderTotalPrice").value = formatCurrency(
            order.total_price || 0
          );
          document.getElementById("orderPayMethod").value =
            order.pay_method || "Ch∆∞a x√°c ƒë·ªãnh";
          document.getElementById("orderCreatedDate").value = order.created_date
            ? new Date(order.created_date).toLocaleString("vi-VN", {
                timeZone: "Asia/Ho_Chi_Minh",
              })
            : "N/A";
          document.getElementById("orderStatus").value = translateStatus(
            order.status
          );

          // X·ª≠ l√Ω hi·ªÉn th·ªã m√£ gi·∫£m gi√° v√† gi√° tr·ªã gi·∫£m gi√°
          const voucherCodeInput = document.getElementById("orderVoucherCode");
          const discountInput = document.getElementById("orderDiscount");
          if (order.discount_applied && order.discount_applied.vccode) {
            voucherCodeInput.value = order.discount_applied.vccode;
            discountInput.value = formatCurrency(order.discount_applied.value);
          } else {
            voucherCodeInput.value = "Kh√¥ng c√≥";
            discountInput.value = "Kh√¥ng c√≥";
          }

          document.getElementById("orderCustomerName").value =
            order.customer_name ||
            order.user?.full_name ||
            "Kh√°ch kh√¥ng x√°c ƒë·ªãnh";
          document.getElementById("orderCustomerEmail").value =
            order.customer_email || order.user?.email || "N/A";
          document.getElementById("orderCustomerPhone").value =
            order.customer_phone || order.user?.phone || "N/A";

          const itemsList = document.getElementById("orderItemsList");
          if (
            order.items &&
            Array.isArray(order.items) &&
            order.items.length > 0
          ) {
            itemsList.innerHTML = order.items
              .map(
                (item) => `
            <div style="padding: 10px; border-bottom: 1px solid #eee;">
              <strong>${
                item.product?.name ||
                item.product_name ||
                "S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh"
              }</strong>
              <br>
              S·ªë l∆∞·ª£ng: ${item.quantity || 0}<br>
              Gi√°: ${formatCurrency(
                item.price_at_purchase || item.price || 0
              )}<br>
              T·ªïng: ${formatCurrency(
                (item.quantity || 0) *
                  (item.price_at_purchase || item.price || 0)
              )}
            </div>
          `
              )
              .join("");
          } else {
            itemsList.innerHTML = "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</p>";
          }

          document.getElementById("orderModal").classList.add("show");
        } catch (error) {
          console.error("‚ùå View order error:", error);
          showNotification(
            `Kh√¥ng th·ªÉ xem chi ti·∫øt ƒë∆°n h√†ng: ${error.message}`,
            "error"
          );
        } finally {
          hideLoading();
        }
      }

      function cancelOrder(id) {
        const order = orders.find((o) => o.id === id);
        if (!order) {
          showNotification("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng", "error");
          return;
        }
        orderToCancel = { ...order };
        document.getElementById("cancelOrderId").textContent = `#${order.id
          .toString()
          .padStart(8, "0")}`;
        document.getElementById("cancelModal").classList.add("show");
      }

      // ==================== MODAL FUNCTIONS ==================
      function closeOrderModal() {
        document.getElementById("orderModal").classList.remove("show");
      }

      function closeCancelModal() {
        document.getElementById("cancelModal").classList.remove("show");
        orderToCancel = null;
      }

      async function cancelOrderConfirm() {
        if (!orderToCancel) {
          showNotification("Kh√¥ng c√≥ ƒë∆°n h√†ng ƒë·ªÉ h·ªßy", "error");
          return;
        }

        const confirmBtn = document.getElementById("confirmCancelBtn");
        confirmBtn.disabled = true;

        try {
          showLoading("ƒêang h·ªßy ƒë∆°n h√†ng...");
          console.log("üóëÔ∏è Canceling order:", orderToCancel.id);
          const response = await fetch(
            `/api/orders/${orderToCancel.id}/cancel`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: "canceled" }),
            }
          );

          const result = await response.json();
          if (response.ok && result.success) {
            showNotification("H·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!", "success");
            closeCancelModal();
            cache.clear(); // X√≥a cache ƒë·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi
            await loadOrders();
            filteredOrders = [...orders];
            displayOrders(filteredOrders);
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Cancel order error:", error);
          showNotification(`Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng: ${error.message}`, "error");
        } finally {
          hideLoading();
          confirmBtn.disabled = false;
        }
      }

      // ==================== PROFILE FUNCTIONS ==================
      function viewProfile() {
        document.getElementById("dropdownMenu").classList.remove("show");
        document.getElementById("profileModal").classList.add("show");
      }

      function closeProfileModal() {
        document.getElementById("profileModal").classList.remove("show");
        document.getElementById("profileOldPassword").value = "";
        document.getElementById("profileNewPassword").value = "";
        document.getElementById("profileConfirmPassword").value = "";
        document.getElementById("profileShowPassword").checked = false;
      }

      async function saveProfile() {
        const oldPassword = document
          .getElementById("profileOldPassword")
          .value.trim();
        const newPassword = document
          .getElementById("profileNewPassword")
          .value.trim();
        const confirmPassword = document
          .getElementById("profileConfirmPassword")
          .value.trim();
        const fullName = document
          .getElementById("profileFullName")
          .value.trim();

        if (!fullName) {
          showNotification("Vui l√≤ng ƒëi·ªÅn h·ªç v√† t√™n", "warning");
          return;
        }

        if (
          (newPassword || confirmPassword) &&
          (!oldPassword || !newPassword || !confirmPassword)
        ) {
          showNotification(
            "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin m·∫≠t kh·∫©u",
            "warning"
          );
          return;
        }

        if (newPassword && newPassword !== confirmPassword) {
          showNotification("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp", "error");
          return;
        }

        if (newPassword && newPassword.length < 6) {
          showNotification("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", "error");
          return;
        }

        try {
          showLoading("ƒêang c·∫≠p nh·∫≠t th√¥ng tin...");
          const endpoint =
            currentUser.role === "admin"
              ? "/api/admin/update"
              : "/api/auth/update-profile";
          const updateData = {
            full_name: fullName,
            ...(oldPassword && newPassword
              ? { old_password: oldPassword, new_password: newPassword }
              : {}),
          };

          console.log("üì§ Updating profile via:", endpoint, updateData);
          const response = await fetch(endpoint, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          const result = await response.json();
          if (response.ok && result.success) {
            showNotification("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!", "success");
            currentUser = {
              ...currentUser,
              ...result.user,
              full_name: fullName,
            };
            updateUserInfo(currentUser);
            closeProfileModal();
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Profile update error:", error);
          showNotification(`L·ªói c·∫≠p nh·∫≠t th√¥ng tin: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== LOGOUT FUNCTIONALITY ==================
      async function logout() {
        console.log("üö™ Logging out...");
        document.getElementById("dropdownMenu").classList.remove("show");
        try {
          showLoading("ƒêang ƒëƒÉng xu·∫•t...");
          const response = await fetch("/api/auth/logout", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });
          localStorage.removeItem("token");
          sessionStorage.removeItem("token");
          authToken = null;
          currentUser = null;
          console.log("üßπ Cleared auth data");
          window.location.href = "/login";
        } catch (error) {
          console.error("‚ùå Logout error:", error);
          localStorage.removeItem("token");
          sessionStorage.removeItem("token");
          authToken = null;
          window.location.href = "/login";
        } finally {
          hideLoading();
        }
      }

      // ==================== UTILITY FUNCTIONS ==================
      function formatCurrency(amount) {
        if (!amount && amount !== 0) return "0 ƒë";
        if (amount >= 1000000) {
          return (amount / 1000000).toFixed(1) + "M ƒë";
        } else if (amount >= 1000) {
          return Math.round(amount / 1000) + "k ƒë";
        } else {
          return new Intl.NumberFormat("vi-VN").format(amount) + " ƒë";
        }
      }

      function translateStatus(status) {
        const statusMap = {
          pending: "Ch·ªù x·ª≠ l√Ω",
          processing: "ƒêang x·ª≠ l√Ω",
          shipped: "ƒêang giao",
          delivered: "ƒê√£ giao",
          completed: "Ho√†n th√†nh",
          cancelled: "ƒê√£ h·ªßy",
        };
        return statusMap[status?.toLowerCase()] || "Kh√¥ng x√°c ƒë·ªãnh";
      }

      function showNotification(message, type = "success", duration = 4000) {
        const existingNotifications =
          document.querySelectorAll(".notification");
        existingNotifications.forEach((notification) => notification.remove());

        const sanitizedMessage = message.replace(/<[^>]+>/g, "");
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        const icons = {
          success: "check-circle",
          error: "exclamation-triangle",
          warning: "exclamation-circle",
          info: "info-circle",
        };

        notification.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${sanitizedMessage}`;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.4s ease forwards";
          setTimeout(() => notification.remove(), 400);
        }, duration);
      }

      function showLoading(message = "ƒêang t·∫£i...") {
        const overlay = document.getElementById("loadingOverlay");
        const text = overlay.querySelector(".loading-text");
        if (text) text.textContent = message;
        overlay.classList.add("show");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("show");
      }

      // ==================== EVENT LISTENERS ==================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîß Setting up event listeners...");

        const settingsBtn = document.getElementById("settingsBtn");
        const dropdownMenu = document.getElementById("dropdownMenu");
        if (settingsBtn && dropdownMenu) {
          settingsBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
          });
        }

        document.addEventListener("click", (e) => {
          if (
            settingsBtn &&
            dropdownMenu &&
            !settingsBtn.contains(e.target) &&
            !dropdownMenu.contains(e.target)
          ) {
            dropdownMenu.classList.remove("show");
          }
        });

        const profileBtn = document.getElementById("profileBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        if (profileBtn) profileBtn.addEventListener("click", viewProfile);
        if (logoutBtn) logoutBtn.addEventListener("click", logout);

        const closeProfileModalBtn = document.getElementById(
          "closeProfileModalBtn"
        );
        const profileCancelBtn = document.getElementById("profileCancelBtn");
        const profileSaveBtn = document.getElementById("profileSaveBtn");
        const profileShowPassword = document.getElementById(
          "profileShowPassword"
        );
        if (closeProfileModalBtn)
          closeProfileModalBtn.addEventListener("click", closeProfileModal);
        if (profileCancelBtn)
          profileCancelBtn.addEventListener("click", closeProfileModal);
        if (profileSaveBtn)
          profileSaveBtn.addEventListener("click", saveProfile);
        if (profileShowPassword) {
          profileShowPassword.addEventListener("change", () => {
            const type = profileShowPassword.checked ? "text" : "password";
            document.getElementById("profileOldPassword").type = type;
            document.getElementById("profileNewPassword").type = type;
            document.getElementById("profileConfirmPassword").type = type;
          });
        }

        const profileModal = document.getElementById("profileModal");
        if (profileModal) {
          profileModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay"))
              closeProfileModal();
          });
        }

        const closeOrderModalBtn = document.getElementById("closeOrderModal");
        const closeOrderBtn = document.getElementById("closeOrderBtn");
        if (closeOrderModalBtn)
          closeOrderModalBtn.addEventListener("click", closeOrderModal);
        if (closeOrderBtn)
          closeOrderBtn.addEventListener("click", closeOrderModal);

        const orderModal = document.getElementById("orderModal");
        if (orderModal) {
          orderModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) closeOrderModal();
          });
        }

        const closeCancelModalBtn = document.getElementById("closeCancelModal");
        const cancelCancelBtn = document.getElementById("cancelCancelBtn");
        const confirmCancelBtn = document.getElementById("confirmCancelBtn");
        if (closeCancelModalBtn)
          closeCancelModalBtn.addEventListener("click", closeCancelModal);
        if (cancelCancelBtn)
          cancelCancelBtn.addEventListener("click", closeCancelModal);
        if (confirmCancelBtn)
          confirmCancelBtn.addEventListener("click", cancelOrderConfirm);

        const cancelModal = document.getElementById("cancelModal");
        if (cancelModal) {
          cancelModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay"))
              closeCancelModal();
          });
        }

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeProfileModal();
            closeOrderModal();
            closeCancelModal();
          }
        });

        setupFilters();
        setupOrderActions();

        console.log("‚úÖ Event listeners setup complete");
      });

      // ================= ORDER ACTIONS EVENT DELEGATION ===
      async function updatePaymentStatus(id, paymentStatus) {
        try {
          showLoading(`ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n...`);
          const response = await fetch(`/api/orders/${id}/payment`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ payment_status: paymentStatus }),
          });
          const result = await response.json();
          if (response.ok && result.success) {
            showNotification(
              `C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng`,
              "success"
            );
            cache.clear(); // X√≥a cache ƒë·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu
            await loadOrders();
            filteredOrders = [...orders];
            displayOrders(filteredOrders);
          } else {
            throw new Error(
              result.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n"
            );
          }
        } catch (error) {
          console.error(`‚ùå Update payment status error: ${error.message}`);
          showNotification(`L·ªói: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      function setupOrderActions() {
        const ordersGrid = document.getElementById("ordersGrid");
        if (ordersGrid) {
          ordersGrid.addEventListener("click", function (e) {
            const orderCard = e.target.closest(".order-card");
            const actionButton = e.target.closest(".action-btn");

            if (orderCard) {
              e.stopPropagation();
              console.log("üñ±Ô∏è Click on order card, stopping propagation");
            }

            if (!actionButton) {
              console.log("üñ±Ô∏è Click outside action button, ignoring");
              return;
            }

            e.preventDefault();
            const orderId = parseInt(
              actionButton.getAttribute("data-order-id")
            );
            const action = actionButton.getAttribute("data-action");
            console.log(`üîß Action ${action} for order ID: ${orderId}`);

            if (!orderId) {
              console.error(
                "Invalid order ID:",
                actionButton.getAttribute("data-order-id")
              );
              showNotification("M√£ ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá", "error");
              return;
            }

            if (action === "view") {
              viewOrder(orderId);
            } else if (action === "cancel") {
              cancelOrder(orderId);
            } else if (action === "paid") {
              updatePaymentStatus(orderId, "paid");
            } else if (action === "unpaid") {
              updatePaymentStatus(orderId, "unpaid");
            }
          });
          console.log("‚úÖ Order actions event delegation set up");
        }
      }

      // ================= NAVIGATION ===
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");
          const href = item.getAttribute("href");
          console.log(`üîó Navigating to: ${href}`);
          window.location.href = href;
        });
      });

      // ================= INITIALIZATION ===
      async function initApp() {
        console.log("üöÄ Initializing Orders Page...");
        try {
          const isAuthenticated = await checkAuth();
          if (isAuthenticated) {
            console.log("‚úÖ Authentication successful");
            const searchInput = document.getElementById("searchInput");
            if (searchInput) searchInput.value = "";
            await loadOrders();
            filteredOrders = [...orders];
            displayOrders(filteredOrders);
            console.log("‚úÖ Orders page initialized successfully!");
          }
        } catch (error) {
          console.error("‚ùå App initialization error:", error);
          showNotification("L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng", "error");
          setTimeout(() => redirectToLogin(), 2000);
        }
      }

      document.addEventListener("DOMContentLoaded", initApp);

      console.log("‚úÖ Orders Page Script Loaded");
    </script>
  </body>
</html>
