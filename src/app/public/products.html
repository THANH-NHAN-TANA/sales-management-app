<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S·∫£n ph·∫©m - Sales Management System</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 10px;
        font-size: 22px;
      }

      .nav-menu {
        display: flex;
        gap: 25px;
        align-items: center;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: 8px;
        padding: 8px;
        border-radius: 5px;
        transition: 0.3s ease;
        text-decoration: none;
        color: #fff;
        font-weight: 500;
        position: relative;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: bold 600;
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .user-name {
        font-weight: 18px;
        font-size: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #f0f0f0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #667eea;
        font-size: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
        border-color: rgba(255, 0, 255, 0.5);
      }

      .settings-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 120%;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        min-width: 220px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-15px);
        transition: all 0.4s ease;
        z-index: 1000;
        overflow: 0px;
        border: 1px solid rgba(0, 0, 0.1);
      }

      .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .dropdown-item:hover {
        background: #f8f9fa;
      }

      .dropdown-item:first-child {
        border-bottom: 1px solid #eee;
      }

      .dropdown-item:first-child:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .dropdown-item:last-child:hover {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      .dropdown-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
        min-height: calc(100vh - 80px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
      }

      .page-subtitle {
        color: #7f8c8d;
        font-size: 16px;
        margin-top: 5px;
      }

      .add-product-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .add-product-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .products-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .section-header {
        padding: 25px 30px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .search-filters {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .search-input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        width: 250px;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .filter-select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-select:focus {
        outline: none;
        border-color: #667eea;
      }

      /* Products Grid */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        padding: 30px;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        position: relative;
        transition: all 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .product-image {
        width: 100%;
        height: 200px;
        overflow: hidden;
        position: relative;
      }

      .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .product-image:hover img {
        transform: scale(1.05);
      }

      .hot-label {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #e74c3c;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .product-info {
        padding: 20px;
        flex-grow: 1;
      }

      .product-name {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .product-category {
        color: #7f8c8d;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .product-price {
        font-size: 20px;
        font-weight: 700;
        color: #27ae60;
        margin-bottom: 12px;
      }

      .product-stock {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
      }

      .stock-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .stock-in {
        background: #d4edda;
        color: #155724;
      }

      .stock-low {
        background: #fff3cd;
        color: #856404;
      }

      .stock-out {
        background: #f8d7da;
        color: #721c24;
      }

      .product-description {
        color: #7f8c8d;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 12px;
      }

      .product-meta {
        color: #95a5a6;
        font-size: 12px;
      }

      .product-actions {
        padding: 15px 20px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #f0f0f0;
      }

      .action-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .btn-edit {
        background: #17a2b8;
        color: white;
      }

      .btn-edit:hover {
        background: #138496;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background: #c82333;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: #7f8c8d;
      }

      .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #bdc3c7;
      }

      .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #95a5a6;
      }

      .empty-state p {
        font-size: 16px;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #667eea;
        font-weight: 600;
        font-size: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 25px;
        right: 25px;
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        z-index: 3000;
        animation: slideInRight 0.4s ease;
        max-width: 350px;
        font-weight: 500;
      }

      .notification.success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .notification.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .notification.warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .notification.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s ease;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 35px;
        max-width: 500px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.4s ease;
        position: relative;
      }

      .modal-overlay.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
      }

      .modal-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-modal:hover {
        background: #f0f0f0;
        color: #666;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: #f9f9f9;
        color: #333;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: white;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 25px;
        border-top: 1px solid #eee;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #e9e9e9;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
      }

      /* Delete Confirmation Modal */
      .delete-modal .modal-content {
        max-width: 400px;
        text-align: center;
      }

      .delete-icon {
        background: #dc3545;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 20px;
      }

      .delete-message {
        font-size: 16px;
        color: #666;
        margin-bottom: 10px;
      }

      .delete-product-name {
        font-weight: 700;
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 25px;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .nav-menu {
          display: none;
        }

        .main-content {
          padding: 20px 15px;
        }

        .page-header {
          flex-direction: column;
          gap: 20px;
          align-items: flex-start;
        }

        .search-filters {
          flex-direction: column;
          width: 100%;
        }

        .search-input,
        .filter-select {
          width: 100%;
        }

        .products-grid {
          grid-template-columns: 1fr;
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .modal-content {
          padding: 25px 20px;
          margin: 20px;
        }

        .product-description {
          font-size: 13px;
        }

        .product-meta {
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <header class="header">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>MeTroMini Store</span>
      </div>

      <nav class="nav-menu">
        <a
          href="/dashboard"
          class="nav-item nav-dashboard"
          data-page="dashboard"
        >
          <i class="fas fa-home"></i>
          T·ªïng quan
        </a>
        <a
          href="/products-page"
          class="nav-item nav-products"
          data-page="products"
        >
          <i class="fas fa-box"></i>
          S·∫£n ph·∫©m
        </a>
        <a
          href="/customers-page"
          class="nav-item nav-customers"
          data-page="customers"
        >
          <i class="fas fa-users"></i>
          Kh√°ch h√†ng
        </a>
        <a href="/orders-page" class="nav-item nav-orders" data-page="orders">
          <i class="fas fa-shopping-cart"></i>
          ƒê∆°n h√†ng
        </a>
        <a
          href="/statistics-page"
          class="nav-item nav-statistics"
          data-page="statistics"
        >
          <i class="fas fa-chart-bar"></i>
          Th·ªëng k√™
        </a>
      </nav>

      <div class="user-info">
        <span class="user-name" id="userName">ƒêang t·∫£i...</span>
        <div class="user-avatar" id="userAvatar" title="Th√¥ng tin c√° nh√¢n">
          ?
        </div>
        <button class="settings-btn" id="settingsBtn" title="C√†i ƒë·∫∑t">
          <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <button class="dropdown-item" id="profileBtn">
            <i class="fas fa-user dropdown-icon"></i>
            Th√¥ng tin c√° nh√¢n
          </button>
          <button class="dropdown-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt dropdown-icon"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
          <p class="page-subtitle">Qu·∫£n l√Ω danh s√°ch s·∫£n ph·∫©m trong h·ªá th·ªëng</p>
        </div>
        <button class="add-product-btn" id="addProductBtn">
          <i class="fas fa-plus"></i>
          Th√™m s·∫£n ph·∫©m
        </button>
      </div>

      <div class="products-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-box"></i>
            Danh s√°ch s·∫£n ph·∫©m
          </h2>
          <div class="search-filters">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="T√¨m ki·∫øm theo t√™n s·∫£n ph·∫©m..."
              autocomplete="new-text"
              name="search_random"
            />
            <select class="filter-select" id="categoryFilter">
              <option value="">T·∫•t c·∫£ danh m·ª•c</option>
              <option value="ca01">Rau c·ªß</option>
              <option value="ca02">Tr√°i c√¢y</option>
              <option value="ca03">ƒê·ªì u·ªëng</option>
              <option value="ca04">ƒê·ªì ƒÉn nh·∫π</option>
              <option value="ca05">Gia v·ªã</option>
              <option value="ca06">V·ªá sinh</option>
              <option value="ca07">H√†ng t·∫°p h√≥a</option>
            </select>
            <select class="filter-select" id="stockFilter">
              <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="instock">C√≤n h√†ng</option>
              <option value="lowstock">S·∫Øp h·∫øt</option>
              <option value="outstock">H·∫øt h√†ng</option>
            </select>
          </div>
        </div>

        <div class="products-grid" id="productsGrid">
          <!-- Products will be loaded here -->
        </div>
      </div>
    </main>

    <!-- Profile Modal -->
    <div class="modal-overlay profile-modal" id="profileModal">
      <div class="modal-content">
        <button class="close-modal" id="closeProfileModalBtn" title="ƒê√≥ng">
          √ó
        </button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-user"></i>
          </div>
          <h2 class="modal-title">Th√¥ng tin c√° nh√¢n</h2>
        </div>

        <div class="profile-section">
          <div class="section-title">
            <i class="fas fa-id-card"></i>
            Th√¥ng tin t√†i kho·∫£n
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input
                type="text"
                class="form-input"
                id="profileUsername"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label">Vai tr√≤</label>
              <input
                type="text"
                class="form-input"
                id="profileUserRole"
                readonly
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="profileEmail" readonly />
          </div>

          <div class="form-group">
            <label class="form-label">H·ªç v√† t√™n</label>
            <input type="text" class="form-input" id="profileFullName" />
          </div>
        </div>

        <div class="profile-section password-section">
          <div class="section-title">
            <i class="fas fa-lock"></i>
            ƒê·ªïi m·∫≠t kh·∫©u
          </div>

          <div class="form-group">
            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input
              type="password"
              class="form-input"
              id="profileOldPassword"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                class="form-input"
                id="profileNewPassword"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
              />
            </div>
            <div class="form-group">
              <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
              <input
                type="password"
                class="form-input"
                id="profileConfirmPassword"
                placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
              />
            </div>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="profileShowPassword" />
            <label for="profileShowPassword">Hi·ªÉn th·ªã m·∫≠t kh·∫©u</label>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-secondary" id="profileCancelBtn">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button class="btn btn-primary" id="profileSaveBtn">
            <i class="fas fa-save"></i>
            C·∫≠p nh·∫≠t
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal-overlay" id="productModal">
      <div class="modal-content">
        <button class="close-modal" id="closeProductModal" title="ƒê√≥ng">
          √ó
        </button>

        <div class="modal-header">
          <div class="modal-icon">
            <i class="fas fa-box" id="modalIcon"></i>
          </div>
          <h2 class="modal-title" id="modalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
        </div>

        <form id="productForm">
          <div class="form-group">
            <label class="form-label">T√™n s·∫£n ph·∫©m *</label>
            <input
              type="text"
              class="form-input"
              id="productName"
              placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Gi√° b√°n *</label>
              <input
                type="number"
                class="form-input"
                id="productPrice"
                placeholder="0.00"
                step="0.01"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <input type="checkbox" id="isHot" name="form-checkbox" />
              <label for="isHot">S·∫£n ph·∫©m n·ªïi b·∫≠t</label>
            </div>
            <div class="form-group">
              <label class="form-label">S·ªë l∆∞·ª£ng *</label>
              <input
                type="number"
                class="form-input"
                id="productStock"
                placeholder="0"
                min="0"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Danh m·ª•c *</label>
            <select class="form-select" id="productCategory" required>
              <option value="">Ch·ªçn danh m·ª•c</option>
              <option value="ca01">Rau c·ªß</option>
              <option value="ca02">Tr√°i c√¢y</option>
              <option value="ca03">ƒê·ªì u·ªëng</option>
              <option value="ca04">ƒê·ªì ƒÉn nh·∫π</option>
              <option value="ca05">Gia v·ªã</option>
              <option value="ca06">V·ªá sinh</option>
              <option value="ca07">H√†ng t·∫°p h√≥a</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">H√¨nh ·∫£nh (URL)</label>
            <input
              type="url"
              class="form-input"
              id="productImageUrl"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <div class="form-group">
            <label class="form-label">M√¥ t·∫£</label>
            <textarea
              class="form-input"
              id="productDescription"
              placeholder="M√¥ t·∫£ s·∫£n ph·∫©m (t√πy ch·ªçn)"
              rows="3"
              style="resize: vertical"
            ></textarea>
          </div>

          <div class="modal-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              id="cancelProductBtn"
            >
              <i class="fas fa-times"></i>
              H·ªßy
            </button>
            <button type="submit" class="btn btn-primary" id="saveProductBtn">
              <i class="fas fa-save"></i>
              <span id="saveButtonText">Th√™m s·∫£n ph·∫©m</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay delete-modal" id="deleteModal">
      <div class="modal-content">
        <button class="close-modal" id="closeDeleteModal" title="ƒê√≥ng">
          √ó
        </button>

        <div class="delete-icon">
          <i class="fas fa-trash"></i>
        </div>

        <h2 class="modal-title">X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m</h2>

        <p class="delete-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m:</p>
        <div class="delete-product-name" id="deleteProductName"></div>

        <p class="delete-message" style="color: #dc3545; font-weight: 600">
          H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!
        </p>

        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="fas fa-trash"></i>
            X√≥a s·∫£n ph·∫©m
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("üöÄ Products Page Loading...");

      // ===================== GLOBAL VARIABLES =====================
      let currentUser = null;
      let authToken = localStorage.getItem("authToken");
      let products = [];
      let filteredProducts = [];
      let editingProductId = null; // Track if we're editing or adding
      let productToDelete = null; // Track product to be deleted

      // ===================== AUTHENTICATION =====================
      async function checkAuth() {
        if (!authToken) {
          console.log("‚ùå No auth token found");
          redirectToLogin();
          return false;
        }

        // Ki·ªÉm tra token c√≥ h·ª£p l·ªá v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng
        try {
          const tokenParts = authToken.split(".");
          if (tokenParts.length !== 3) {
            throw new Error("Invalid token format");
          }
          const payload = JSON.parse(atob(tokenParts[1]));
          const expiry = payload.exp * 1000; // Chuy·ªÉn sang milliseconds
          if (Date.now() > expiry) {
            console.log("‚ùå Token expired locally");
            localStorage.removeItem("authToken");
            localStorage.removeItem("user");
            authToken = null;
            showNotification("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n", "error");
            redirectToLogin();
            return false;
          }
        } catch (error) {
          console.error("‚ùå Invalid token:", error.message);
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          authToken = null;
          showNotification("Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá", "error");
          redirectToLogin();
          return false;
        }

        try {
          showLoading("ƒêang x√°c th·ª±c...");
          console.log("üîç Verifying authentication token");

          const response = await fetch("/api/auth/verify", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            console.log("üîç Auth response:", result);

            if (result.success && result.user) {
              currentUser = result.user;

              if (
                !currentUser.name &&
                !currentUser.fullName &&
                !currentUser.full_name
              ) {
                currentUser.name = currentUser.username || "User";
              }

              updateUserInfo(currentUser);
              console.log(
                "‚úÖ Authentication verified for:",
                currentUser.username || currentUser.name || currentUser.role
              );
              return true;
            } else {
              throw new Error("Invalid response format");
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error("‚ùå Auth response error:", errorData);
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Auth verification failed:", error.message);
          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          authToken = null;
          showNotification("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n", "error");
          redirectToLogin();
          return false;
        } finally {
          hideLoading();
        }
      }

      function redirectToLogin() {
        console.log("üîÑ Redirecting to login page");
        window.location.href = "/login";
      }

      function updateUserInfo(user) {
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");

        // X·ª≠ l√Ω t√™n hi·ªÉn th·ªã cho admin user
        let displayName =
          user.fullName ||
          user.full_name ||
          user.name ||
          user.username ||
          "User";

        // ƒê·∫£m b·∫£o c√≥ t√™n hi·ªÉn th·ªã cho admin
        if (user.role === "admin" && !displayName) {
          displayName = "Admin";
        }

        console.log("üë§ Updating user info:", {
          displayName,
          role: user.role,
          username: user.username,
          fullName: user.fullName,
          full_name: user.full_name,
          name: user.name,
        });

        if (userName) {
          userName.textContent = displayName;
        }

        if (userAvatar) {
          userAvatar.textContent = displayName.charAt(0).toUpperCase();
          userAvatar.title = `${
            user.role === "admin" ? "Admin" : "User"
          }: ${displayName}`;
        }

        // Update profile modal fields
        const profileUsername = document.getElementById("profileUsername");
        const profileUserRole = document.getElementById("profileUserRole");
        const profileEmail = document.getElementById("profileEmail");
        const profileFullName = document.getElementById("profileFullName");

        if (profileUsername) {
          profileUsername.value =
            user.username || (user.role === "admin" ? "admin" : "");
        }
        if (profileUserRole) {
          profileUserRole.value =
            user.role === "admin" ? "Admin" : user.role || "User";
        }
        if (profileEmail) {
          profileEmail.value = user.email || "";
        }
        if (profileFullName) {
          profileFullName.value =
            user.fullName || user.full_name || user.name || "";
        }
      }
      // ===================== PRODUCTS DATA =====================
      async function loadProducts() {
        try {
          showLoading("ƒêang t·∫£i s·∫£n ph·∫©m...");
          console.log("üì¶ Loading products...");

          const response = await fetch("/api/products", {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            console.log("üîç API /api/products response:", result);
            if (result.success && Array.isArray(result.products)) {
              products = result.products;
              filteredProducts = [...products];
              displayProducts(filteredProducts);
            } else {
              throw new Error(result.error || "Invalid response format");
            }
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Load products error:", error);
          products = [];
          filteredProducts = [];
          showNotification(
            `Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m: ${error.message}`,
            "error"
          );
          displayEmptyState();
        } finally {
          hideLoading();
        }
      }
      // ===================== DISPLAY FUNCTIONS =====================
      function displayProducts(productsToShow) {
        const productsGrid = document.getElementById("productsGrid");
        if (!productsGrid) {
          console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ productsGrid");
          return;
        }

        if (productsToShow.length === 0) {
          console.warn("‚ö†Ô∏è Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã");
          console.log("üîç Debug m·∫•t s·∫£n ph·∫©m:", {
            productsLength: products.length,
            filteredProductsLength: filteredProducts.length,
            searchInput: document.getElementById("searchInput")?.value,
            categoryFilter: document.getElementById("categoryFilter")?.value,
            stockFilter: document.getElementById("stockFilter")?.value,
          });
          displayEmptyState();
          return;
        }

        console.log("üîç Rendering products:", productsToShow);
        productsGrid.innerHTML = productsToShow
          .map((product) => createProductCard(product))
          .join("");

        console.log(`‚úÖ Hi·ªÉn th·ªã ${productsToShow.length} s·∫£n ph·∫©m`);
      }

      function formatVNDCurrency(amount) {
        if (!amount) return "0ƒë";
        if (amount >= 1000000) {
          return (amount / 1000000).toFixed(1) + "M ƒë";
        } else if (amount >= 1000) {
          return Math.round(amount / 1000) + "k ƒë";
        } else {
          return new Intl.NumberFormat("vi-VN").format(amount) + " ƒë";
        }
      }

      function createProductCard(product) {
        if (!product.id) {
          console.error("‚ùå Product missing ID:", product);
          return "";
        }
        if (!product.name || !product.price || product.stock === undefined) {
          console.warn("‚ö†Ô∏è Product missing required fields:", product);
        }

        // ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng t·ªìn t·∫°i
        const name = product.name || "S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh";
        const category_name = product.category_name || "Ch∆∞a ph√¢n lo·∫°i";
        const price_vnd =
          product.price_vnd || formatVNDCurrency(product.price || 0);
        const stock = product.stock || 0;
        const image_url = product.image_url || "/images/placeholder.jpg";
        const stock_status = product.stock_status || getStockStatus(stock);
        const short_description = product.short_description || "Kh√¥ng c√≥ m√¥ t·∫£";
        const is_hot = product.is_hot || false;
        const created_at = product.created_at
          ? new Date(product.created_at).toLocaleDateString("vi-VN")
          : "N/A";
        const updated_at = product.updated_at
          ? new Date(product.updated_at).toLocaleDateString("vi-VN")
          : "N/A";

        return `
    <div class="product-card" data-product-id="${product.id}">
      <div class="product-image">
        <img src="${image_url}" 
             alt="${name}" 
             onerror="this.src='/images/placeholder.jpg'">
        ${is_hot ? '<span class="hot-label">Hot</span>' : ""}
      </div>
      <div class="product-info">
        <h3 class="product-name">${name}</h3>
        <p class="product-category">Danh m·ª•c: ${category_name}</p>
        <p class="product-price">Gi√°: ${price_vnd}</p>
        <p class="product-stock ${stock_status.class}">
          T·ªìn kho: ${stock} (${stock_status.text})
        </p>
        <p class="product-description">${short_description}</p>
        <p class="product-meta">
          T·∫°o: ${created_at} | C·∫≠p nh·∫≠t: ${updated_at}
        </p>
      </div>
      <div class="product-actions">
        <button class="action-btn btn-edit" data-action="edit" data-product-id="${
          product.id
        }">
          <i class="fas fa-edit"></i> S·ª≠a
        </button>
        <button class="action-btn btn-delete" data-action="delete" data-product-id="${
          product.id
        }">
          <i class="fas fa-trash"></i> X√≥a
        </button>
      </div>
    </div>
  `;
      }

      function getCategoryIcon(categoryId) {
        const icons = {
          ca01: "fas fa-carrot", // Rau c·ªß
          ca02: "fas fa-apple-alt", // Tr√°i c√¢y
          ca03: "fas fa-coffee", // ƒê·ªì u·ªëng
          ca04: "fas fa-cookie-bite", // ƒê·ªì ƒÉn nh·∫π
          ca05: "fas fa-pepper-hot", // Gia v·ªã
          ca06: "fas fa-soap", // V·ªá sinh
          ca07: "fas fa-home", // H√†ng t·∫°p h√≥a
          // Fallback for old categories
          Electronics: "fas fa-mobile-alt",
          Computers: "fas fa-laptop",
          Audio: "fas fa-headphones",
          Tablets: "fas fa-tablet-alt",
          Wearables: "fas fa-watch",
        };
        return icons[categoryId] || "fas fa-box";
      }

      function formatVNDPrice(price) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(price);
      }

      function getStockStatus(stock) {
        if (stock === 0) {
          return { class: "stock-out", text: "H·∫øt h√†ng" };
        } else if (stock <= 10) {
          return { class: "stock-low", text: "S·∫Øp h·∫øt" };
        } else {
          return { class: "stock-in", text: "C√≤n h√†ng" };
        }
      }

      function displayEmptyState() {
        const productsGrid = document.getElementById("productsGrid");
        const searchTerm =
          document.getElementById("searchInput")?.value.trim() || "";

        let message = "Ch∆∞a c√≥ s·∫£n ph·∫©m trong danh s√°ch.";
        if (searchTerm) {
          message = `Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi "${searchTerm}".`;
        }

        productsGrid.innerHTML = `
    <div class="empty-state" style="grid-column: 1 / -1;">
      <i class="fas fa-box-open"></i>
      <h3>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</h3>
      <p>${message}</p>
    </div>
  `;
      }

      // ===================== SEARCH AND FILTER =====================
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Update setupFilters to use debounced applyFilters
      function setupFilters() {
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");
        const stockFilter = document.getElementById("stockFilter");

        if (!searchInput || !categoryFilter || !stockFilter) {
          console.warn("‚ö†Ô∏è Filter inputs not found");
          return;
        }

        // Prevent browser autofill
        searchInput.setAttribute("autocomplete", "new-text");
        searchInput.setAttribute("type", "text");
        searchInput.setAttribute("name", `search_${Date.now()}`); // Randomize name to block autofill

        // Clear input on page load
        searchInput.value = "";
        console.log("‚úÖ Search input cleared on load");

        // Clear email-like input on focus or input
        searchInput.addEventListener("focus", () => {
          if (searchInput.value.includes("@")) {
            console.warn(
              "‚ö†Ô∏è Detected email in searchInput:",
              searchInput.value
            );
            searchInput.value = "";
          }
        });
        searchInput.addEventListener("input", () => {
          if (searchInput.value.includes("@")) {
            console.warn(
              "‚ö†Ô∏è Detected email in searchInput:",
              searchInput.value
            );
            searchInput.value = "";
          }
        });

        const debouncedApplyFilters = debounce(applyFilters, 300);
        searchInput.addEventListener("input", debouncedApplyFilters);
        categoryFilter.addEventListener("change", debouncedApplyFilters);
        stockFilter.addEventListener("change", debouncedApplyFilters);

        console.log("‚úÖ Filters setup with enhanced autofill prevention");
      }

      function applyFilters() {
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");
        const stockFilter = document.getElementById("stockFilter");

        if (
          !searchInput ||
          !categoryFilter ||
          !stockFilter ||
          !products ||
          products.length === 0
        ) {
          console.warn("‚ö†Ô∏è B·ªô l·ªçc ho·∫∑c danh s√°ch s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá");
          displayProducts(products || []);
          showNotification("Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ l·ªçc", "warning");
          return;
        }

        const searchTerm = searchInput.value.toLowerCase().trim();
        const categoryFilterValue = categoryFilter.value;
        const stockFilterValue = stockFilter.value;

        console.log("üîç √Åp d·ª•ng b·ªô l·ªçc:", {
          searchTerm,
          categoryFilterValue,
          stockFilterValue,
        });

        if (!searchTerm && !categoryFilterValue && !stockFilterValue) {
          filteredProducts = [...products];
          displayProducts(filteredProducts);
          console.log("üîç Kh√¥ng c√≥ b·ªô l·ªçc, hi·ªÉn th·ªã t·∫•t c·∫£ s·∫£n ph·∫©m");
          return;
        }

        filteredProducts = products.filter((product) => {
          if (
            !product ||
            !product.name ||
            !product.category_id ||
            product.stock === undefined
          ) {
            console.warn("‚ö†Ô∏è S·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá:", product);
            return false;
          }

          const matchesSearch =
            !searchTerm || product.name.toLowerCase().includes(searchTerm);
          const matchesCategory =
            !categoryFilterValue || product.category_id === categoryFilterValue;
          const matchesStock = filterByStock(product, stockFilterValue);

          return matchesSearch && matchesCategory && matchesStock;
        });

        console.log(`üîç ƒê√£ l·ªçc ƒë∆∞·ª£c ${filteredProducts.length} s·∫£n ph·∫©m`);

        if (filteredProducts.length === 0 && searchTerm) {
          showNotification(
            `Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi "${searchTerm}"`,
            "info"
          );
        }

        displayProducts(filteredProducts);
      }

      function filterByStock(product, stockFilter) {
        switch (stockFilter) {
          case "instock":
            return product.stock > 10;
          case "lowstock":
            return product.stock > 0 && product.stock <= 10;
          case "outstock":
            return product.stock === 0;
          default:
            return true;
        }
      }

      // ===================== PRODUCT ACTIONS =====================
      function addProduct() {
        editingProductId = null;
        document.getElementById("modalTitle").textContent = "Th√™m s·∫£n ph·∫©m m·ªõi";
        document.getElementById("modalIcon").className = "fas fa-plus";
        document.getElementById("saveButtonText").textContent = "Th√™m s·∫£n ph·∫©m";

        // Clear form
        document.getElementById("productForm").reset();

        // Show modal
        document.getElementById("productModal").classList.add("show");
      }

      function editProduct(id) {
        const product = products.find((p) => p.id === id);
        if (!product) {
          showNotification("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m", "error");
          return;
        }
        editingProductId = id; // Keep as string (e.g., 'pr22')
        console.log("üñ±Ô∏è H√†nh ƒë·ªông edit cho s·∫£n ph·∫©m ID:", editingProductId);
        document.getElementById("modalTitle").textContent = "S·ª≠a s·∫£n ph·∫©m";
        document.getElementById("modalIcon").className = "fas fa-edit";
        document.getElementById("saveButtonText").textContent = "L∆∞u thay ƒë·ªïi";
        document.getElementById("productName").value = product.name;
        document.getElementById("productPrice").value = product.price;
        document.getElementById("productStock").value = product.stock;
        document.getElementById("productCategory").value =
          product.category_id || product.category;
        document.getElementById("productDescription").value =
          product.description || "";
        document.getElementById("productImageUrl").value =
          product.image_url || "";
        document.getElementById("productModal").classList.add("show");
      }

      // In deleteProduct, use string ID directly
      function deleteProduct(id) {
        const product = products.find((p) => p.id === id);
        if (!product) {
          showNotification("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m", "error");
          return;
        }
        productToDelete = { ...product, id: id }; // Keep as string
        document.getElementById("deleteProductName").textContent = product.name;
        document.getElementById("deleteModal").classList.add("show");
      }

      // ===================== MODAL FUNCTIONS =====================
      function closeProductModal() {
        document.getElementById("productModal").classList.remove("show");
        document.getElementById("productForm").reset();
        // Clear image URL field specifically
        document.getElementById("productImageUrl").value = "";
        editingProductId = null;
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.remove("show");
        productToDelete = null;
      }

      async function saveProduct(event) {
        event.preventDefault();
        const saveButton = document.getElementById("saveProductBtn");
        if (saveButton.disabled) {
          console.log("üîÑ Y√™u c·∫ßu l∆∞u ƒëang x·ª≠ l√Ω, b·ªè qua...");
          return;
        }
        saveButton.disabled = true;

        const name = document.getElementById("productName").value.trim();
        const price = parseFloat(document.getElementById("productPrice").value);
        const stock = parseInt(document.getElementById("productStock").value);
        const category_id = document.getElementById("productCategory").value;
        const description = document
          .getElementById("productDescription")
          .value.trim();
        const image_url = document
          .getElementById("productImageUrl")
          .value.trim();
        const is_hot = document.getElementById("isHot")?.checked || false; // Th√™m tr∆∞·ªùng hot

        if (!name || !price || isNaN(stock) || !category_id) {
          showNotification("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc", "error");
          saveButton.disabled = false;
          return;
        }
        if (price <= 0) {
          showNotification("Gi√° s·∫£n ph·∫©m ph·∫£i l·ªõn h∆°n 0", "error");
          saveButton.disabled = false;
          return;
        }
        if (stock < 0) {
          showNotification("S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c √¢m", "error");
          saveButton.disabled = false;
          return;
        }

        const productData = {
          name,
          price,
          stock,
          category_id,
          description: description || undefined,
          image_url: image_url || undefined,
          hot: is_hot,
        };

        try {
          showLoading(
            editingProductId ? "ƒêang c·∫≠p nh·∫≠t..." : "ƒêang th√™m s·∫£n ph·∫©m..."
          );
          console.log("üíæ Sending product update:", {
            editingProductId,
            productData,
            url: editingProductId
              ? `/api/products/${editingProductId}`
              : "/api/products",
          });

          const response = await fetch(
            editingProductId
              ? `/api/products/${editingProductId}`
              : "/api/products",
            {
              method: editingProductId ? "PUT" : "POST",
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(productData),
            }
          );

          const result = await response.json();
          console.log("üîç Save product response:", {
            status: response.status,
            result,
          });

          if (response.ok && result.success) {
            showNotification(
              editingProductId
                ? "C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!"
                : "Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!",
              "success"
            );
            closeProductModal();
            await loadProducts();
            filteredProducts = [...products];
            displayProducts(filteredProducts);
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Save product error:", error);
          showNotification(`L·ªói khi l∆∞u s·∫£n ph·∫©m: ${error.message}`, "error");
        } finally {
          hideLoading();
          saveButton.disabled = false;
        }
      }

      async function confirmDelete() {
        if (!productToDelete) return;

        const confirmButton = document.getElementById("confirmDeleteBtn");
        confirmButton.disabled = true; // Disable button to prevent multiple clicks

        try {
          showLoading("ƒêang x√≥a s·∫£n ph·∫©m...");
          console.log("üóëÔ∏è Deleting product:", productToDelete.id);

          const response = await fetch(`/api/products/${productToDelete.id}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          console.log("üóëÔ∏è Delete response:", {
            status: response.status,
            statusText: response.statusText,
          });

          const result = await response.json();
          console.log("üóëÔ∏è Delete result:", result);

          if (response.ok && result.success) {
            showNotification("X√≥a s·∫£n ph·∫©m th√†nh c√¥ng!", "success");
            closeDeleteModal();
            await loadProducts();
            filteredProducts = [...products];
            displayProducts(filteredProducts);
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Delete product error:", error);
          showNotification(`Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m: ${error.message}`, "error");
        } finally {
          hideLoading();
          confirmButton.disabled = false; // Re-enable button
        }
      }

      // ===================== PROFILE FUNCTIONS =====================
      function viewProfile() {
        document.getElementById("dropdownMenu").classList.remove("show");
        document.getElementById("profileModal").classList.add("show");
      }

      function debugProducts() {
        console.log("üîç Products Debug Info:");
        console.log("- Current products count:", products.length);
        console.log("- Filtered products count:", filteredProducts.length);
        console.log("- Auth token:", authToken ? "Present" : "Missing");
        console.log("- Current user:", currentUser);
        console.log(
          "- Products grid element:",
          document.getElementById("productsGrid")
        );

        // Test API directly
        fetch("/api/products", {
          headers: {
            Authorization: `Bearer ${authToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("üîç Direct API test result:", data);
          })
          .catch((error) => {
            console.error("üîç Direct API test error:", error);
          });
      }

      // Expose debug function
      window.debugProducts = debugProducts;

      console.log("‚úÖ Products system fixes applied successfully");

      function closeProfileModal() {
        document.getElementById("profileModal").classList.remove("show");
        // Clear password fields
        document.getElementById("profileOldPassword").value = "";
        document.getElementById("profileNewPassword").value = "";
        document.getElementById("profileConfirmPassword").value = "";
        document.getElementById("profileShowPassword").checked = false;
      }

      async function saveProfile() {
        const oldPassword = document
          .getElementById("profileOldPassword")
          .value.trim();
        const newPassword = document
          .getElementById("profileNewPassword")
          .value.trim();
        const confirmPassword = document
          .getElementById("profileConfirmPassword")
          .value.trim();
        const fullName = document
          .getElementById("profileFullName")
          .value.trim();

        // Ki·ªÉm tra h·ªç v√† t√™n
        if (!fullName) {
          showNotification("Vui l√≤ng ƒëi·ªÅn h·ªç v√† t√™n", "warning");
          return;
        }

        // Ki·ªÉm tra m·∫≠t kh·∫©u n·∫øu ng∆∞·ªùi d√πng mu·ªën ƒë·ªïi
        let passwordValid = true;
        let includePassword = false;

        if (oldPassword || newPassword || confirmPassword) {
          // N·∫øu b·∫•t k·ª≥ tr∆∞·ªùng m·∫≠t kh·∫©u n√†o ƒë∆∞·ª£c ƒëi·ªÅn, y√™u c·∫ßu c·∫£ ba
          if (!oldPassword || !newPassword || !confirmPassword) {
            showNotification(
              "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin m·∫≠t kh·∫©u",
              "warning"
            );
            passwordValid = false;
          } else if (newPassword !== confirmPassword) {
            showNotification("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp", "error");
            passwordValid = false;
          } else if (newPassword.length < 6) {
            showNotification("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", "error");
            passwordValid = false;
          } else {
            includePassword = true;
          }
        }

        if (!passwordValid) {
          return; // D·ª´ng n·∫øu m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá
        }

        try {
          showLoading("ƒêang c·∫≠p nh·∫≠t th√¥ng tin...");

          const endpoint =
            currentUser.role === "admin"
              ? "/api/admin/update"
              : "/api/auth/update-profile";
          const updateData =
            currentUser.role === "admin"
              ? {
                  full_name: fullName,
                  ...(includePassword && {
                    old_password: oldPassword,
                    new_password: newPassword,
                  }),
                }
              : {
                  fullName: fullName,
                  ...(includePassword && {
                    oldPassword: oldPassword,
                    newPassword: newPassword,
                  }),
                };

          console.log("üì§ Updating profile via:", endpoint, updateData);

          const response = await fetch(endpoint, {
            method: currentUser.role === "admin" ? "POST" : "PUT",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showNotification("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!", "success");

            // L√†m m·ªõi th√¥ng tin ng∆∞·ªùi d√πng t·ª´ server
            try {
              const verifyResponse = await fetch("/api/auth/verify", {
                headers: { Authorization: `Bearer ${authToken}` },
              });
              const verifyResult = await verifyResponse.json();
              if (verifyResult.success && verifyResult.user) {
                currentUser = verifyResult.user;
                updateUserInfo(currentUser);
                console.log("üîÑ ƒê√£ l√†m m·ªõi th√¥ng tin ng∆∞·ªùi d√πng:", currentUser);
              } else {
                console.warn(
                  "‚ö†Ô∏è Kh√¥ng th·ªÉ l√†m m·ªõi th√¥ng tin ng∆∞·ªùi d√πng:",
                  verifyResult.error
                );
              }
            } catch (verifyError) {
              console.error(
                "‚ùå L·ªói khi l√†m m·ªõi th√¥ng tin ng∆∞·ªùi d√πng:",
                verifyError.message
              );
            }

            closeProfileModal();
          } else {
            throw new Error(result.error || `HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("‚ùå Profile update error:", error);
          showNotification(
            error.message || "L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin",
            "error"
          );
        } finally {
          hideLoading();
        }
      }

      function updateNavigationForAdmin() {
        if (currentUser && currentUser.role === "admin") {
          console.log("üîß Updating navigation for admin user");

          const navItems = document.querySelectorAll(".nav-item");
          navItems.forEach((item) => {
            const href = item.getAttribute("href");
            const page = item.getAttribute("data-page");

            // Redirect admin users to admin routes
            if (href && !href.startsWith("/admin") && href !== "#") {
              switch (page) {
                case "dashboard":
                  item.setAttribute("href", "/admin/dashboard");
                  break;
                case "products":
                  item.setAttribute("href", "/products-page");
                  break;
                case "customers":
                  item.setAttribute("href", "/customers-page");
                  break;
                case "orders":
                  item.setAttribute("href", "/orders-page");
                  break;
                case "statistics":
                  item.setAttribute("href", "/statistics-page");
                  break;
              }
            }
          });
        }
      }

      // ===================== LOGOUT FUNCTIONALITY =====================
      async function logout() {
        console.log("üö™ Logout function called");

        const dropdownMenu = document.getElementById("dropdownMenu");
        dropdownMenu.classList.remove("show");

        console.log("üö™ Starting logout process...");

        try {
          showLoading("ƒêang ƒëƒÉng xu·∫•t...");

          localStorage.removeItem("authToken");
          localStorage.removeItem("user");
          authToken = null;
          currentUser = null;

          console.log("üßπ Local data cleared");
          hideLoading();
          console.log("üö™ About to redirect...");

          window.location.href = "/login";
        } catch (error) {
          console.error("‚ùå Logout error:", error);
          hideLoading();
          window.location.href = "/login";
        }
      }

      // ===================== UTILITY FUNCTIONS =====================
      function showLoading(message = "ƒêang t·∫£i...") {
        const overlay = document.getElementById("loadingOverlay");
        const text = overlay.querySelector(".loading-text");
        if (text) text.textContent = message;
        overlay.classList.add("show");
      }

      function hideLoading() {
        const overlay = document.getElementById("loadingOverlay");
        overlay.classList.remove("show");
      }

      function showNotification(message, type = "success", duration = 4000) {
        const existingNotifications =
          document.querySelectorAll(".notification");
        existingNotifications.forEach((notification) => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        });

        // Sanitize message to remove HTML tags
        const sanitizedMessage = message.replace(/<[^>]+>/g, "");

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        const icons = {
          success: "check-circle",
          error: "exclamation-triangle",
          info: "info-circle",
          warning: "exclamation-triangle",
        };

        notification.innerHTML = `
    <i class="fas fa-${icons[type] || icons.info}"></i>
    ${sanitizedMessage}
  `;

        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOutRight 0.4s ease forwards";
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 400);
          }
        }, duration);
      }

      // ===================== EVENT LISTENERS =====================
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîß Setting up event listeners...");

        // Settings dropdown
        const settingsBtn = document.getElementById("settingsBtn");
        const dropdownMenu = document.getElementById("dropdownMenu");

        if (settingsBtn && dropdownMenu) {
          settingsBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (settingsBtn && dropdownMenu) {
            if (
              !settingsBtn.contains(e.target) &&
              !dropdownMenu.contains(e.target)
            ) {
              dropdownMenu.classList.remove("show");
            }
          }
        });

        // Profile and logout buttons
        const profileBtn = document.getElementById("profileBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        if (profileBtn) {
          profileBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("üë§ Profile button clicked");
            viewProfile();
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("üö™ Logout button clicked");
            logout();
          });
        }

        // Profile modal events
        const profileModal = document.getElementById("profileModal");
        const closeProfileModalBtn = document.getElementById(
          "closeProfileModalBtn"
        );
        const profileCancelBtn = document.getElementById("profileCancelBtn");
        const profileSaveBtn = document.getElementById("profileSaveBtn");
        const profileShowPassword = document.getElementById(
          "profileShowPassword"
        );

        if (closeProfileModalBtn) {
          closeProfileModalBtn.addEventListener("click", closeProfileModal);
        }

        if (profileCancelBtn) {
          profileCancelBtn.addEventListener("click", closeProfileModal);
        }

        if (profileSaveBtn) {
          profileSaveBtn.addEventListener("click", saveProfile);
        }

        if (profileShowPassword) {
          profileShowPassword.addEventListener("change", function () {
            const type = this.checked ? "text" : "password";
            document.getElementById("profileOldPassword").type = type;
            document.getElementById("profileNewPassword").type = type;
            document.getElementById("profileConfirmPassword").type = type;
          });
        }

        // Close profile modal when clicking overlay
        if (profileModal) {
          profileModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              closeProfileModal();
            }
          });
        }

        // Add product button
        const addProductBtn = document.getElementById("addProductBtn");
        if (addProductBtn) {
          addProductBtn.addEventListener("click", addProduct);
        }

        // Product modal events
        const productModal = document.getElementById("productModal");
        const closeProductModalBtn =
          document.getElementById("closeProductModal");
        const cancelProductBtn = document.getElementById("cancelProductBtn");
        const productForm = document.getElementById("productForm");

        if (closeProductModalBtn) {
          closeProductModalBtn.addEventListener("click", closeProductModal);
        }

        if (cancelProductBtn) {
          cancelProductBtn.addEventListener("click", closeProductModal);
        }

        if (productForm) {
          productForm.addEventListener("submit", saveProduct);
        }

        // Close modal when clicking overlay
        if (productModal) {
          productModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              closeProductModal();
            }
          });
        }

        // Delete modal events
        const deleteModal = document.getElementById("deleteModal");
        const closeDeleteModalBtn = document.getElementById("closeDeleteModal");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        if (closeDeleteModalBtn) {
          closeDeleteModalBtn.addEventListener("click", closeDeleteModal);
        }

        if (cancelDeleteBtn) {
          cancelDeleteBtn.addEventListener("click", closeDeleteModal);
        }

        if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener("click", confirmDelete);
        }

        // Close delete modal when clicking overlay
        if (deleteModal) {
          deleteModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              closeDeleteModal();
            }
          });
        }

        // Keyboard events
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeProductModal();
            closeDeleteModal();
            closeProfileModal();
          }
        });

        // Setup filters
        setupFilters();

        // Setup product action buttons using event delegation
        setupProductActions();

        console.log("‚úÖ Event listeners setup complete");
      });

      // ===================== PRODUCT ACTIONS EVENT DELEGATION =====================
      function setupProductActions() {
        const productsGrid = document.getElementById("productsGrid");

        if (productsGrid) {
          productsGrid.addEventListener("click", function (e) {
            const productCard = e.target.closest(".product-card");
            const actionButton = e.target.closest("button[data-action]");

            if (productCard) {
              e.stopPropagation();
              console.log("üñ±Ô∏è Click tr√™n product-card, ngƒÉn lan truy·ªÅn");
            }

            if (!actionButton) {
              console.log("üñ±Ô∏è Click ngo√†i n√∫t edit/delete, b·ªè qua:", e.target);
              return;
            }

            e.preventDefault();

            const productId = actionButton.getAttribute("data-product-id"); // Keep as string (e.g., 'pr22')
            const action = actionButton.getAttribute("data-action");

            console.log(`üñ±Ô∏è H√†nh ƒë·ªông ${action} cho s·∫£n ph·∫©m ID: ${productId}`);

            if (!productId) {
              console.error(
                "‚ùå ID s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá:",
                actionButton.getAttribute("data-product-id")
              );
              showNotification("ID s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá", "error");
              return;
            }

            if (action === "edit") {
              editProduct(productId);
            } else if (action === "delete") {
              deleteProduct(productId);
            }
          });

          console.log("‚úÖ ƒê√£ thi·∫øt l·∫≠p x·ª≠ l√Ω h√†nh ƒë·ªông s·∫£n ph·∫©m");
        }
      }

      // ===================== NAVIGATION =====================
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          const href = item.getAttribute("href");
          const page = item.getAttribute("data-page");

          // N·∫øu l√† admin user, cho ph√©p ƒëi·ªÅu h∆∞·ªõng tr·ª±c ti·∫øp
          if (currentUser && currentUser.role === "admin") {
            console.log(`üîó Admin navigation to: ${href}`);
            return;
          }

          // V·ªõi regular users, x·ª≠ l√Ω ƒëi·ªÅu h∆∞·ªõng
          e.preventDefault();
          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");

          // Cho ph√©p ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn b·∫•t k·ª≥ trang n√†o
          window.location.href = href;
        });
      });

      // ===================== INITIALIZATION =====================
      async function initApp() {
        console.log("üöÄ Initializing Products Page...");
        try {
          const isAuthenticated = await checkAuth();
          if (isAuthenticated) {
            console.log("‚úÖ Authentication successful");
            updateNavigationForAdmin();
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
              searchInput.value = "";
              console.log("‚úÖ Cleared search input default value");
            }
            await loadProducts();
            filteredProducts = [...products];
            displayProducts(filteredProducts);
            console.log("‚úÖ Products page initialized successfully!");
          } else {
            console.log("‚ùå Authentication failed - redirecting to login");
          }
        } catch (error) {
          console.error("‚ùå App initialization error:", error);
          showNotification("L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng", "error");
          setTimeout(() => redirectToLogin(), 2000);
        }
      }

      function debugUserInfo() {
        console.log("üîç Current User Debug:", {
          currentUser: currentUser,
          authToken: authToken ? "Present" : "Missing",
          userNameElement: document.getElementById("userName")?.textContent,
          userAvatarElement: document.getElementById("userAvatar")?.textContent,
        });
      }

      // Expose debug function
      window.debugUserInfo = debugUserInfo;

      // ===================== NAVIGATION UPDATE =====================
      // Th√™m v√†o ph·∫ßn navigation event listeners:

      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          const href = item.getAttribute("href");
          const page = item.getAttribute("data-page");

          // N·∫øu l√† admin user v√† ƒëang ·ªü trang products, cho ph√©p navigation b√¨nh th∆∞·ªùng
          if (currentUser && currentUser.role === "admin") {
            // Kh√¥ng prevent default cho admin users
            console.log(`üîó Admin navigation to: ${href}`);
            return;
          }

          // V·ªõi regular users, handle nh∆∞ b√¨nh th∆∞·ªùng
          e.preventDefault();

          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");

          if (page && page !== "products") {
            window.location.href = href;
          }
        });
      });

      console.log("‚úÖ Frontend admin fixes applied successfully");

      // Start the application
      document.addEventListener("DOMContentLoaded", initApp);

      console.log("‚úÖ Products Page Script Loaded");

      // ===================== DEBUG FUNCTIONS =====================
      // Test functions for debugging
      window.testEditProduct = function (id = 1) {
        console.log("üß™ Testing edit product with ID:", id);
        editProduct(id);
      };

      window.testDeleteProduct = function (id = 1) {
        console.log("üß™ Testing delete product with ID:", id);
        deleteProduct(id);
      };

      window.testAddProduct = function () {
        console.log("üß™ Testing add product");
        addProduct();
      };

      console.log("üîß Debug functions available:");
      console.log("- testEditProduct(id) - Test edit product");
      console.log("- testDeleteProduct(id) - Test delete product");
      console.log("- testAddProduct() - Test add product");

      // Auto-test if needed
      window.debugProducts = function () {
        console.log("üîç Current products:", products);
        console.log("üîç Filtered products:", filteredProducts);
        console.log(
          "üîç Products grid element:",
          document.getElementById("productsGrid")
        );

        // Test if buttons exist
        const editBtns = document.querySelectorAll('[data-action="edit"]');
        const deleteBtns = document.querySelectorAll('[data-action="delete"]');
        console.log("üîç Edit buttons found:", editBtns.length);
        console.log("üîç Delete buttons found:", deleteBtns.length);

        if (editBtns.length > 0) {
          console.log("‚úÖ Product action buttons are present");
        } else {
          console.log("‚ùå No product action buttons found");
        }
      };
    </script>
  </body>
</html>
